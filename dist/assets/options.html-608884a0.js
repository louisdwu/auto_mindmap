import{c as K,j as e,r as c}from"./client-a68773c9.js";import{D as C,S as a,c as E}from"./storageService-59ff9c65.js";import{L as D}from"./llmService-fb03cb47.js";(function(){const d=document.createElement("link").relList;if(d&&d.supports&&d.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))m(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&m(o)}).observe(document,{childList:!0,subtree:!0});function p(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function m(n){if(n.ep)return;n.ep=!0;const s=p(n);fetch(n.href,s)}})();function N(){const[i,d]=c.useState(C),[p,m]=c.useState([]),[n,s]=c.useState(""),[o,g]=c.useState(null),[x,b]=c.useState(!1),[S,h]=c.useState(!1),[u,w]=c.useState("");c.useEffect(()=>{y(),j()},[]);const y=async()=>{const t=await a.getConfig();t&&(d(t),s(t.selectedLLMConfigId||"default"))},j=async()=>{const t=await a.getLLMConfigs();m(t);const r=await a.getConfig(),l=(r==null?void 0:r.selectedLLMConfigId)||"default",v=t.find(W=>W.id===l)||t[0];v&&(g(v),s(v.id))},B=async t=>{s(t);const r=p.find(l=>l.id===t);r&&(g(r),await a.setSelectedLLMConfig(t),await y())},z=()=>{const t=E("custom");t.name=`新配置 ${p.length+1}`,g(t),b(!0)},I=async()=>{if(!o){console.log("[Options] handleSaveCurrentConfig: editingConfig is null");return}console.log("[Options] handleSaveCurrentConfig: 开始保存配置",o),console.log("[Options] handleSaveCurrentConfig: API Key =",o.apiKey?o.apiKey.substring(0,8)+"...":"(空)");try{await a.saveLLMConfig(o),console.log("[Options] handleSaveCurrentConfig: saveLLMConfig 成功"),x?(console.log("[Options] handleSaveCurrentConfig: 设置选中配置",o.id),await a.setSelectedLLMConfig(o.id),s(o.id),b(!1)):o.id===n&&(console.log("[Options] handleSaveCurrentConfig: 同步更新当前选中的配置"),await a.setSelectedLLMConfig(o.id)),await j(),await y(),console.log("[Options] handleSaveCurrentConfig: 保存完成"),h(!0),setTimeout(()=>h(!1),2e3)}catch(t){console.error("[Options] handleSaveCurrentConfig: 保存失败",t),alert("保存失败: "+(t instanceof Error?t.message:String(t)))}},R=async t=>{if(p.length<=1){alert("至少需要保留一个配置！");return}if(!confirm("确定要删除这个配置吗？"))return;if(await a.deleteLLMConfig(t)&&(await j(),await y(),t===(o==null?void 0:o.id))){const l=await a.getLLMConfigs();l.length>0&&(g(l[0]),s(l[0].id))}},A=()=>{b(!1);const t=p.find(r=>r.id===n);t&&g(t)},O=async()=>{await a.saveConfig(i),h(!0),setTimeout(()=>h(!1),2e3)},P=async()=>{d(C),await a.saveConfig(C),h(!0),setTimeout(()=>h(!1),2e3)},M=async()=>{try{await chrome.runtime.sendMessage({type:"CLEAR_MINDMAPS"}),alert("缓存已清除！")}catch(t){console.error("清除缓存失败:",t),alert("清除缓存失败")}},f=t=>{o&&g({...o,...t})},k=()=>{if(!u.trim())return;const t=i.exclusionKeywords||[];t.includes(u.trim())||d({...i,exclusionKeywords:[...t,u.trim()]}),w("")},T=t=>{const r=i.exclusionKeywords||[];d({...i,exclusionKeywords:r.filter(l=>l!==t)})};return e.jsxs("div",{style:{padding:"40px",maxWidth:"800px",margin:"0 auto"},children:[e.jsx("h1",{style:{marginBottom:"30px"},children:"插件配置"}),e.jsxs("section",{style:{marginBottom:"30px"},children:[e.jsx("h2",{style:{marginBottom:"15px"},children:"大模型配置"}),e.jsxs("div",{style:{marginBottom:"20px"},children:[e.jsx("label",{style:{display:"block",marginBottom:"10px",fontWeight:"bold"},children:"已保存的配置"}),e.jsxs("div",{style:{display:"flex",flexWrap:"wrap",gap:"10px",marginBottom:"15px"},children:[p.map(t=>e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",padding:"8px 12px",border:n===t.id?"2px solid #3b82f6":"1px solid #d1d5db",borderRadius:"8px",backgroundColor:n===t.id?"#eff6ff":"white",cursor:"pointer",transition:"all 0.2s"},onClick:()=>!x&&B(t.id),children:[e.jsxs("div",{style:{flex:1},children:[e.jsx("div",{style:{fontWeight:"bold",fontSize:"14px"},children:t.name}),e.jsxs("div",{style:{fontSize:"12px",color:"#6b7280"},children:[t.provider==="openai"?"OpenAI":t.provider==="gemini"?"Gemini":"自定义"," · ",t.model]})]}),p.length>1&&e.jsx("button",{onClick:r=>{r.stopPropagation(),R(t.id)},style:{padding:"4px 8px",background:"transparent",border:"none",color:"#ef4444",cursor:"pointer",fontSize:"16px"},title:"删除配置",children:"×"})]},t.id)),e.jsx("button",{onClick:z,disabled:x,style:{display:"flex",alignItems:"center",gap:"5px",padding:"8px 16px",border:"2px dashed #d1d5db",borderRadius:"8px",backgroundColor:"white",cursor:x?"not-allowed":"pointer",fontSize:"14px",color:"#6b7280",transition:"all 0.2s"},children:"+ 新增配置"})]}),x&&e.jsx("div",{style:{padding:"10px",background:"#fef3c7",borderRadius:"6px",marginBottom:"15px",fontSize:"14px",color:"#92400e"},children:'正在添加新配置，请填写下方信息后点击"保存当前配置"'})]}),o&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{style:{marginBottom:"15px"},children:[e.jsx("label",{style:{display:"block",marginBottom:"5px",fontWeight:"bold"},children:"配置名称"}),e.jsx("input",{type:"text",value:o.name,onChange:t=>f({name:t.target.value}),style:{width:"100%",padding:"10px",border:"1px solid #d1d5db",borderRadius:"6px",fontSize:"14px"},placeholder:"例如：GPT-4、Claude API、本地 Ollama"}),e.jsx("p",{style:{fontSize:"12px",color:"#6b7280",marginTop:"5px"},children:"为这个配置起一个便于识别的名称"})]}),e.jsxs("div",{style:{marginBottom:"15px"},children:[e.jsx("label",{style:{display:"block",marginBottom:"5px",fontWeight:"bold"},children:"LLM 提供商"}),e.jsxs("select",{value:o.provider,onChange:t=>{const r=t.target.value,l={provider:r};r==="openai"?(l.apiUrl="https://api.openai.com/v1",l.model="gpt-3.5-turbo"):r==="gemini"?(l.apiUrl="https://generativelanguage.googleapis.com/v1beta",l.model="gemini-1.5-flash"):r==="custom"&&(l.apiUrl="",l.model=""),f(l)},style:{width:"100%",padding:"10px",border:"1px solid #d1d5db",borderRadius:"6px",fontSize:"14px",backgroundColor:"white"},children:[e.jsx("option",{value:"openai",children:"OpenAI (GPT-3.5/GPT-4)"}),e.jsx("option",{value:"gemini",children:"Google Gemini"}),e.jsx("option",{value:"custom",children:"自定义 (OpenAI 兼容)"})]}),e.jsx("p",{style:{fontSize:"12px",color:"#6b7280",marginTop:"5px"},children:"选择您要使用的 LLM 服务提供商"})]}),e.jsxs("div",{style:{marginBottom:"15px"},children:[e.jsx("label",{style:{display:"block",marginBottom:"5px",fontWeight:"bold"},children:"API地址"}),e.jsx("input",{type:"text",value:o.apiUrl,onChange:t=>f({apiUrl:t.target.value}),style:{width:"100%",padding:"10px",border:"1px solid #d1d5db",borderRadius:"6px",fontSize:"14px"},placeholder:"https://api.openai.com/v1"}),e.jsx("p",{style:{fontSize:"12px",color:"#6b7280",marginTop:"5px"},children:o.provider==="gemini"?"Gemini API 地址，例如：https://generativelanguage.googleapis.com/v1beta":o.provider==="openai"?"OpenAI API 地址，例如：https://api.openai.com/v1":"自定义 API 地址，需兼容 OpenAI API 格式"}),o.apiUrl&&e.jsxs("div",{style:{marginTop:"8px",padding:"8px 12px",backgroundColor:"#f3f4f6",borderRadius:"6px",border:"1px solid #e5e7eb"},children:[e.jsx("div",{style:{fontSize:"12px",color:"#6b7280",marginBottom:"4px"},children:"实际请求地址："}),e.jsx("code",{style:{fontSize:"12px",color:"#1f2937",wordBreak:"break-all",fontFamily:"monospace"},children:D.getFullRequestUrl(o.provider,o.apiUrl,o.model)})]})]}),e.jsxs("div",{style:{marginBottom:"15px"},children:[e.jsx("label",{style:{display:"block",marginBottom:"5px",fontWeight:"bold"},children:"API密钥"}),e.jsx("input",{type:"text",value:o.apiKey,onChange:t=>f({apiKey:t.target.value}),style:{width:"100%",padding:"10px",border:"1px solid #d1d5db",borderRadius:"6px",fontSize:"14px"},placeholder:"sk-..."})]}),e.jsxs("div",{style:{marginBottom:"15px"},children:[e.jsx("label",{style:{display:"block",marginBottom:"5px",fontWeight:"bold"},children:"模型名称"}),e.jsx("input",{type:"text",value:o.model,onChange:t=>f({model:t.target.value}),style:{width:"100%",padding:"10px",border:"1px solid #d1d5db",borderRadius:"6px",fontSize:"14px"},placeholder:o.provider==="gemini"?"gemini-1.5-flash":"gpt-3.5-turbo"})]}),e.jsxs("div",{style:{marginBottom:"15px"},children:[e.jsx("label",{style:{display:"block",marginBottom:"5px",fontWeight:"bold"},children:"超时时间 (秒)"}),e.jsx("input",{type:"number",value:o.timeout||60,onChange:t=>f({timeout:parseInt(t.target.value)||60}),style:{width:"100%",padding:"10px",border:"1px solid #d1d5db",borderRadius:"6px",fontSize:"14px"},min:"5",max:"300"}),e.jsx("p",{style:{fontSize:"12px",color:"#6b7280",marginTop:"5px"},children:"API 请求的超时时间，建议 30-120 秒"})]}),e.jsxs("div",{style:{display:"flex",gap:"10px",marginBottom:"20px"},children:[e.jsx("button",{onClick:I,style:{padding:"10px 20px",background:"#10b981",color:"white",border:"none",borderRadius:"6px",fontSize:"14px",cursor:"pointer",fontWeight:"bold"},children:S?"✓ 已保存":x?"保存新配置":"保存当前配置"}),x&&e.jsx("button",{onClick:A,style:{padding:"10px 20px",background:"#6b7280",color:"white",border:"none",borderRadius:"6px",fontSize:"14px",cursor:"pointer"},children:"取消"})]})]})]}),e.jsxs("section",{style:{marginBottom:"30px"},children:[e.jsx("h2",{style:{marginBottom:"15px"},children:"Prompt模板"}),e.jsxs("div",{style:{marginBottom:"15px"},children:[e.jsx("label",{style:{display:"block",marginBottom:"5px",fontWeight:"bold"},children:"Prompt模板"}),e.jsx("textarea",{value:i.prompt.template,onChange:t=>d({...i,prompt:{...i.prompt,template:t.target.value}}),style:{width:"100%",padding:"10px",border:"1px solid #d1d5db",borderRadius:"6px",fontSize:"14px",minHeight:"200px",fontFamily:"monospace"},placeholder:"请输入Prompt模板，使用 {subtitle_content} 作为字幕内容的占位符"}),e.jsxs("p",{style:{fontSize:"12px",color:"#6b7280",marginTop:"5px"},children:["使用 ","{subtitle_content}"," 作为字幕内容的占位符"]})]})]}),e.jsxs("section",{style:{marginBottom:"30px"},children:[e.jsx("h2",{style:{marginBottom:"15px"},children:"自动运行例外设置"}),e.jsxs("div",{style:{marginBottom:"15px"},children:[e.jsx("label",{style:{display:"block",marginBottom:"5px",fontWeight:"bold"},children:"排除关键词"}),e.jsxs("div",{style:{display:"flex",gap:"10px",marginBottom:"10px"},children:[e.jsx("input",{type:"text",value:u,onChange:t=>w(t.target.value),onKeyDown:t=>t.key==="Enter"&&k(),placeholder:"输入关键词后按回车添加",style:{flex:1,padding:"10px",border:"1px solid #d1d5db",borderRadius:"6px",fontSize:"14px"}}),e.jsx("button",{onClick:k,style:{padding:"0 20px",background:"#3b82f6",color:"white",border:"none",borderRadius:"6px",fontSize:"14px",cursor:"pointer"},children:"添加"})]}),e.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:"8px"},children:(i.exclusionKeywords||[]).map((t,r)=>e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"6px",padding:"6px 12px",background:"#f3f4f6",borderRadius:"20px",fontSize:"14px",color:"#374151"},children:[e.jsx("span",{children:t}),e.jsx("button",{onClick:()=>T(t),style:{background:"transparent",border:"none",color:"#9ca3af",cursor:"pointer",fontSize:"16px",padding:"0 2px",lineHeight:1},children:"×"})]},r))}),e.jsx("p",{style:{fontSize:"12px",color:"#6b7280",marginTop:"10px"},children:"当视频标题包含以上任意关键词时，插件将不会自动生成思维导图"})]})]}),e.jsxs("section",{style:{marginBottom:"30px"},children:[e.jsx("h2",{style:{marginBottom:"15px"},children:"缓存设置"}),e.jsxs("div",{style:{marginBottom:"20px"},children:[e.jsx("label",{style:{display:"block",marginBottom:"5px",fontWeight:"bold"},children:"启用思维导图缓存"}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"10px"},children:[e.jsx("input",{type:"checkbox",checked:i.settings.enableCache,onChange:t=>d({...i,settings:{...i.settings,enableCache:t.target.checked}}),style:{width:"18px",height:"18px"}}),e.jsx("span",{style:{fontSize:"14px",color:"#374151"},children:i.settings.enableCache?"已启用 - 相同视频会优先使用缓存的思维导图":"未启用 - 每次都会重新生成思维导图"})]}),e.jsx("p",{style:{fontSize:"12px",color:"#6b7280",marginTop:"5px"},children:"开启后，相同视频会优先使用已生成的思维导图，节省API调用次数"})]}),e.jsxs("div",{style:{marginBottom:"15px"},children:[e.jsx("label",{style:{display:"block",marginBottom:"5px",fontWeight:"bold"},children:"启用本地文件缓存"}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"10px"},children:[e.jsx("input",{type:"checkbox",checked:i.settings.cacheDirectory.trim().length>0,onChange:t=>d({...i,settings:{...i.settings,cacheDirectory:t.target.checked?"enabled":""}}),style:{width:"18px",height:"18px"}}),e.jsx("span",{style:{fontSize:"14px",color:"#374151"},children:i.settings.cacheDirectory.trim().length>0?"已启用 - 文件将保存到 Chrome 下载目录的 bilibili_mindmap 文件夹":"未启用 - 文件只保存在插件内存中"})]})]}),i.settings.cacheDirectory.trim().length>0&&e.jsx("div",{style:{padding:"12px",background:"#f0fdf4",borderRadius:"6px",border:"1px solid #86efac"},children:e.jsxs("p",{style:{fontSize:"13px",color:"#166534",margin:0},children:[e.jsx("strong",{children:"缓存说明："}),"生成的字幕(.txt)和思维导图(.md)文件将自动保存到 Chrome 默认下载目录下的 ",e.jsx("code",{children:"bilibili_mindmap"})," 文件夹中。 请在 Chrome 设置中确认下载目录位置。"]})})]}),e.jsxs("div",{style:{display:"flex",gap:"10px"},children:[e.jsx("button",{onClick:O,style:{padding:"12px 24px",background:"#3b82f6",color:"white",border:"none",borderRadius:"6px",fontSize:"16px",cursor:"pointer",fontWeight:"bold"},children:S?"✓ 已保存":"保存配置"}),e.jsx("button",{onClick:P,style:{padding:"12px 24px",background:"#6b7280",color:"white",border:"none",borderRadius:"6px",fontSize:"16px",cursor:"pointer"},children:"重置默认"})]}),e.jsxs("div",{style:{marginTop:"20px"},children:[e.jsx("button",{onClick:M,style:{padding:"10px 20px",background:"#ef4444",color:"white",border:"none",borderRadius:"6px",fontSize:"14px",cursor:"pointer"},children:"清除思维导图缓存"}),e.jsx("p",{style:{fontSize:"12px",color:"#6b7280",marginTop:"5px"},children:"清除所有已下载的字幕和思维导图数据"})]})]})}const L=document.getElementById("root");L&&K(L).render(e.jsx(N,{}));
