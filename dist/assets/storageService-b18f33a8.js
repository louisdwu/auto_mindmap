function d(){return`llm_${Date.now()}_${Math.random().toString(36).substring(2,9)}`}function p(g="openai"){const t=Date.now(),e={openai:{name:"OpenAI GPT",provider:"openai",apiUrl:"https://api.openai.com/v1",model:"gpt-3.5-turbo"},gemini:{name:"Google Gemini",provider:"gemini",apiUrl:"https://generativelanguage.googleapis.com/v1beta",model:"gemini-1.5-flash"},custom:{name:"自定义配置",provider:"custom",apiUrl:"",model:""}};return{id:d(),...e[g],apiKey:"",timeout:60,createdAt:t,updatedAt:t}}const f={id:"default",name:"OpenAI GPT (默认)",provider:"openai",apiUrl:"https://api.openai.com/v1",apiKey:"",model:"gpt-3.5-turbo",timeout:60,createdAt:0,updatedAt:0},m={selectedLLMConfigId:"default",llm:{provider:"openai",apiUrl:"https://api.openai.com/v1",apiKey:"",model:"gpt-3.5-turbo",timeout:60},prompt:{template:`请将以下视频字幕内容总结为一个思维导图，使用纯Markdown格式。

要求：
1. 使用标准的Markdown标题层级（# 一级标题、## 二级标题等）表示思维导图结构
2. 使用无序列表（-）表示分支节点
3. 提取主要观点和关键信息
4. 保持逻辑层次清晰
5. 使用简洁的语言
6. 不要使用任何特殊语法或Mermaid

字幕内容：
{subtitle_content}

请直接输出Markdown格式的思维导图，不要包含其他说明文字。`},settings:{language:"zh-CN",cacheDirectory:"",enableCache:!0},exclusionKeywords:[]},u={isPaused:!1},o={CONFIG:"plugin_config",LLM_CONFIGS:"llm_configs",MINDMAPS:"mindmaps",LATEST_MINDMAP_ID:"latest_mindmap_id",EXTENSION_STATE:"extension_state"};class L{static async getConfig(){const e=(await chrome.storage.sync.get(o.CONFIG))[o.CONFIG];return e?{...e,selectedLLMConfigId:e.selectedLLMConfigId||"default",llm:{...e.llm,timeout:e.llm.timeout||60},settings:{...e.settings,enableCache:e.settings.enableCache!==void 0?e.settings.enableCache:!0},exclusionKeywords:e.exclusionKeywords||[]}:null}static async saveConfig(t){await chrome.storage.sync.set({[o.CONFIG]:t})}static async getLLMConfigsRaw(){return(await chrome.storage.sync.get(o.LLM_CONFIGS))[o.LLM_CONFIGS]||[]}static async getLLMConfigs(){const t=await this.getLLMConfigsRaw();if(t.length===0){const e=await this.getConfig();if(e&&e.llm.apiKey){const i={id:"migrated_default",name:`${e.llm.provider==="openai"?"OpenAI":e.llm.provider==="gemini"?"Gemini":"自定义"} (已迁移)`,provider:e.llm.provider,apiUrl:e.llm.apiUrl,apiKey:e.llm.apiKey,model:e.llm.model,timeout:e.llm.timeout||60,createdAt:Date.now(),updatedAt:Date.now()};return await chrome.storage.sync.set({[o.LLM_CONFIGS]:[i]}),await this.saveConfig({...e,selectedLLMConfigId:i.id}),[i]}return[f]}return t}static async getLLMConfigById(t){return(await this.getLLMConfigs()).find(i=>i.id===t)||null}static async getSelectedLLMConfig(){const t=await this.getConfig(),e=(t==null?void 0:t.selectedLLMConfigId)||"default",i=await this.getLLMConfigs();return i.find(a=>a.id===e)||i[0]||null}static async saveLLMConfig(t){console.log("[StorageService] saveLLMConfig: 开始保存",t);let e=await this.getLLMConfigsRaw();(!e||e.length===0)&&(e=[]),console.log("[StorageService] saveLLMConfig: 当前配置列表",e);const i=e.findIndex(s=>s.id===t.id);console.log("[StorageService] saveLLMConfig: existingIndex =",i),i>=0?(e[i]={...t,updatedAt:Date.now()},console.log("[StorageService] saveLLMConfig: 更新现有配置")):(e.push({...t,updatedAt:Date.now()}),console.log("[StorageService] saveLLMConfig: 添加新配置")),console.log("[StorageService] saveLLMConfig: 准备保存的配置列表",e),await chrome.storage.sync.set({[o.LLM_CONFIGS]:e}),console.log("[StorageService] saveLLMConfig: 保存完成")}static async deleteLLMConfig(t){const e=await this.getLLMConfigs();if(e.length<=1)return!1;const i=e.filter(a=>a.id!==t);await chrome.storage.sync.set({[o.LLM_CONFIGS]:i});const s=await this.getConfig();return s&&s.selectedLLMConfigId===t&&await this.saveConfig({...s,selectedLLMConfigId:i[0].id}),!0}static async setSelectedLLMConfig(t){let e=await this.getConfig();e||(e={...m});const i=await this.getLLMConfigById(t);i&&await this.saveConfig({...e,selectedLLMConfigId:t,llm:{provider:i.provider,apiUrl:i.apiUrl,apiKey:i.apiKey,model:i.model,timeout:i.timeout}})}static async getMindmaps(){return(await chrome.storage.local.get(o.MINDMAPS))[o.MINDMAPS]||[]}static async saveMindmap(t){const e=await this.getMindmaps(),i=e.findIndex(s=>s.id===t.id);i>=0?e[i]=t:e.unshift(t),e.length>50&&e.splice(50),await chrome.storage.local.set({[o.MINDMAPS]:e,[o.LATEST_MINDMAP_ID]:t.id})}static async getLatestMindmap(){const e=(await chrome.storage.local.get(o.LATEST_MINDMAP_ID))[o.LATEST_MINDMAP_ID];return e&&(await this.getMindmaps()).find(s=>s.id===e)||null}static async getMindmapById(t){return(await this.getMindmaps()).find(i=>i.id===t)||null}static async getLatestMindmapByUrl(t){console.log("[StorageService] getLatestMindmapByUrl 被调用, URL:",t);const e=await this.getMindmaps();console.log("[StorageService] 存储的思维导图数量:",e.length),e.length>0&&console.log("[StorageService] 存储的思维导图列表:",e.map(n=>({id:n.id,videoTitle:n.videoTitle,videoUrl:n.videoUrl})));const i=n=>{try{const r=new URL(n).pathname.match(/\/video\/(BV[\w]+|av\d+)/i);return r?r[1]:null}catch{return null}},s=i(t);console.log("[StorageService] 提取的视频ID:",s);const a=e.filter(n=>s?i(n.videoUrl)===s:n.videoUrl===t);return console.log("[StorageService] 匹配的思维导图数量:",a.length),a.length>0?a[0]:null}static async deleteMindmap(t){const i=(await this.getMindmaps()).filter(s=>s.id!==t);await chrome.storage.local.set({[o.MINDMAPS]:i})}static async clearMindmaps(){await chrome.storage.local.remove([o.MINDMAPS,o.LATEST_MINDMAP_ID])}static async getExtensionState(){return(await chrome.storage.local.get(o.EXTENSION_STATE))[o.EXTENSION_STATE]||u}static async saveExtensionState(t){await chrome.storage.local.set({[o.EXTENSION_STATE]:t})}static async isPaused(){return(await this.getExtensionState()).isPaused}static async setPaused(t){const e=await this.getExtensionState();await this.saveExtensionState({...e,isPaused:t})}static async togglePaused(){const t=await this.getExtensionState(),e=!t.isPaused;return await this.saveExtensionState({...t,isPaused:e}),e}static async exportConfig(){const t=await this.getConfig(),e=await this.getLLMConfigs();return{version:"1.0",exportDate:new Date().toISOString(),pluginConfig:t,llmConfigs:e}}static async importConfig(t,e={}){const{overwriteExisting:i=!0,mergeLLMConfigs:s=!1}=e;try{let a=0;if(t.pluginConfig&&i&&await this.saveConfig(t.pluginConfig),t.llmConfigs&&t.llmConfigs.length>0)if(s){const n=await this.getLLMConfigsRaw(),c=new Set(n.map(r=>r.id));for(const r of t.llmConfigs)if(!c.has(r.id)){const l={...r,id:`imported_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,name:r.name+" (导入)",updatedAt:Date.now()};n.push(l),a++}await chrome.storage.sync.set({[o.LLM_CONFIGS]:n})}else{const n=t.llmConfigs.map(r=>({...r,updatedAt:Date.now()}));await chrome.storage.sync.set({[o.LLM_CONFIGS]:n}),a=n.length;const c=await this.getConfig();c&&!n.some(l=>l.id===c.selectedLLMConfigId)&&n.length>0&&await this.saveConfig({...c,selectedLLMConfigId:n[0].id})}return{success:!0,message:"配置导入成功",importedLLMConfigsCount:a}}catch(a){return console.error("[StorageService] 导入配置失败:",a),{success:!1,message:a instanceof Error?a.message:"导入失败",importedLLMConfigsCount:0}}}static async downloadConfigFile(){const t=await this.exportConfig(),e=JSON.stringify(t,null,2),i=new Blob([e],{type:"application/json"}),s=URL.createObjectURL(i),a=`auto_mindmap_config_${new Date().toISOString().slice(0,10)}.json`,n=document.createElement("a");n.href=s,n.download=a,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(s)}static async readConfigFromFile(t){return new Promise((e,i)=>{const s=new FileReader;s.onload=a=>{var n;try{const c=(n=a.target)==null?void 0:n.result,r=JSON.parse(c);e(r)}catch{i(new Error("无法解析配置文件，请确保文件格式正确"))}},s.onerror=()=>{i(new Error("读取文件失败"))},s.readAsText(t)})}}export{m as D,L as S,p as c};
