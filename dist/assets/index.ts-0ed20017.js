import{S as he}from"./storageService-b18f33a8.js";import{r as m,j as e,R as ke,c as Me}from"./client-a68773c9.js";let G=new Set,ne=new Set,le=null;function Se(t){try{const i=new URL(t).pathname.match(/\/video\/(BV[\w]+|av\d+)/i);return i?i[1]:null}catch{return null}}function Ce(){te(window.location.href)&&(console.log("[Content] Detected Bilibili video page, auto-starting..."),ee(window.location.href));let t=window.location.href;const n=new MutationObserver(()=>{if(window.location.href!==t){const i=window.location.href;console.log("[Content] URL changed:",t,"->",i),t=i,ne.clear(),te(i)&&(console.log("[Content] Detected Bilibili video page, auto-starting..."),ee(i))}});window.addEventListener("popstate",()=>{const i=window.location.href;console.log("[Content] Popstate event, URL:",i),te(i)&&ee(i)}),n.observe(document.body,{childList:!0,subtree:!0}),document.addEventListener("spf.navigate",()=>{console.log("[Content] SPF navigate event");const i=window.location.href;te(i)&&ee(i)})}function ee(t){const n=Se(t);if(!n){console.log("[Content] 无法提取视频ID，跳过:",t);return}if(ne.has(n)||G.has(n)){console.log("[Content] 视频已处理或正在处理中，跳过:",n);return}G.add(n),le&&clearTimeout(le),le=setTimeout(async()=>{var u;try{if(await he.isPaused()){console.log("[Content] 插件已暂停，跳过自动生成思维导图"),G.clear();return}}catch(s){console.error("[Content] Failed to check pause state:",s)}try{const s=await he.getConfig(),c=(s==null?void 0:s.exclusionKeywords)||[];if(c.length>0){const a=document.querySelector(".video-title")||document.querySelector("h1"),o=((u=a==null?void 0:a.textContent)==null?void 0:u.trim())||document.title;if(o){const p=c.find(f=>o.includes(f));if(p){console.log(`[Content] Video title "${o}" matches exclusion keyword "${p}", skipping auto-generation.`),G.clear();return}}}}catch(s){console.error("[Content] Failed to check exclusion keywords:",s)}const i=Array.from(G);G.clear();for(const s of i)ne.has(s)||(ne.add(s),await Le(t))},2e3)}function te(t){try{const n=new URL(t);return n.hostname==="www.bilibili.com"&&n.pathname.startsWith("/video/")}catch{return!1}}async function Le(t){console.log("[Content] Downloading subtitle for:",t);try{const n=await chrome.runtime.sendMessage({type:"DOWNLOAD_SUBTITLE",payload:{videoUrl:t}});console.log("[Content] Download task created:",n.taskId)}catch(n){console.error("[Content] Download failed:",n)}}const Ie=({showNotification:t,currentTask:n,onClick:i})=>{const[u,s]=m.useState(!1),[c,a]=m.useState(!1),o=(n==null?void 0:n.status)==="failed",p=o?"linear-gradient(135deg, #e74c3c 0%, #c0392b 100%)":"linear-gradient(135deg, #667eea 0%, #764ba2 100%)",f=()=>{if(!n)return"暂无任务";const w={download_subtitle:"下载字幕",generate_mindmap:"生成思维导图"},g={pending:{text:"等待中",color:"#f39c12"},running:{text:"进行中",color:"#27ae60"},completed:{text:"已完成",color:"#3498db"},failed:{text:"失败",color:"#e74c3c"}},x=w[n.type]||n.type,v=g[n.status]||{text:n.status,color:"#95a5a6"};return e.jsxs("div",{style:{fontSize:"13px",lineHeight:"1.5"},children:[e.jsx("div",{style:{fontWeight:500,marginBottom:"4px"},children:x}),e.jsx("div",{style:{color:v.color,fontSize:"12px"},children:v.text}),o&&n.errorMessage&&e.jsx("div",{style:{color:"#f39c12",fontSize:"11px",marginTop:"6px",maxWidth:"200px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:"点击查看详情"})]})};return e.jsxs("div",{style:{position:"relative"},children:[e.jsxs("div",{onClick:()=>{o&&(n!=null&&n.errorMessage)?a(!0):i()},onMouseEnter:w=>{s(!0),w.currentTarget.style.transform="scale(1.1)",w.currentTarget.style.boxShadow="0 6px 20px rgba(0, 0, 0, 0.4)"},onMouseLeave:w=>{s(!1),w.currentTarget.style.transform="scale(1)",w.currentTarget.style.boxShadow="0 4px 15px rgba(0, 0, 0, 0.3)"},style:{position:"fixed",bottom:"30px",left:"30px",width:"60px",height:"60px",borderRadius:"50%",background:p,boxShadow:"0 4px 15px rgba(0, 0, 0, 0.3)",cursor:"pointer",zIndex:999998,display:"flex",alignItems:"center",justifyContent:"center",transition:"transform 0.2s, box-shadow 0.2s"},children:[o?e.jsxs("svg",{width:"30",height:"30",viewBox:"0 0 24 24",fill:"none",stroke:"white",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("line",{x1:"15",y1:"9",x2:"9",y2:"15"}),e.jsx("line",{x1:"9",y1:"9",x2:"15",y2:"15"})]}):e.jsxs("svg",{width:"30",height:"30",viewBox:"0 0 24 24",fill:"none",stroke:"white",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("path",{d:"M12 6v6l4 2"})]}),t&&e.jsx("div",{style:{position:"absolute",top:"5px",right:"5px",width:"16px",height:"16px",borderRadius:"50%",background:"#ff4757",border:"2px solid white",animation:"pulse 2s infinite"}}),e.jsx("style",{children:`
          @keyframes pulse {
            0%, 100% {
              transform: scale(1);
              opacity: 1;
            }
            50% {
              transform: scale(1.2);
              opacity: 0.8;
            }
          }
        `})]}),u&&e.jsxs("div",{style:{position:"fixed",bottom:"100px",left:"30px",background:"rgba(0, 0, 0, 0.85)",color:"white",padding:"10px 14px",borderRadius:"8px",fontSize:"13px",zIndex:999999,minWidth:"180px",maxWidth:"280px",boxShadow:"0 4px 12px rgba(0, 0, 0, 0.3)",animation:"fadeIn 0.2s ease-out"},children:[f(),e.jsx("style",{children:`
            @keyframes fadeIn {
              from { opacity: 0; transform: translateY(5px); }
              to { opacity: 1; transform: translateY(0); }
            }
          `})]}),c&&e.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(0, 0, 0, 0.6)",zIndex:999999,display:"flex",alignItems:"center",justifyContent:"center"},onClick:()=>a(!1),children:e.jsxs("div",{style:{background:"white",borderRadius:"12px",padding:"20px",maxWidth:"400px",width:"90%",boxShadow:"0 10px 40px rgba(0, 0, 0, 0.3)"},onClick:w=>w.stopPropagation(),children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",marginBottom:"15px",color:"#e74c3c"},children:[e.jsxs("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",style:{marginRight:"10px"},children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("line",{x1:"12",y1:"8",x2:"12",y2:"12"}),e.jsx("line",{x1:"12",y1:"16",x2:"12.01",y2:"16"})]}),e.jsx("h3",{style:{margin:0,fontSize:"18px"},children:"任务失败"})]}),e.jsx("div",{style:{background:"#fef2f2",border:"1px solid #fecaca",borderRadius:"8px",padding:"12px",color:"#991b1b",fontSize:"14px",lineHeight:"1.6",marginBottom:"15px"},children:(n==null?void 0:n.errorMessage)||"未知错误"}),e.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",gap:"10px"},children:[e.jsx("button",{onClick:()=>a(!1),style:{padding:"8px 16px",border:"1px solid #d1d5db",borderRadius:"6px",background:"white",color:"#374151",cursor:"pointer"},children:"关闭"}),e.jsx("button",{onClick:()=>{a(!1),i()},style:{padding:"8px 16px",border:"none",borderRadius:"6px",background:"#3b82f6",color:"white",cursor:"pointer"},children:"重新生成"})]})]})})]})};function Ee(t){const n=t.split(`
`);let i={id:"root",text:"中心主题",level:0,children:[],expanded:!0};for(const o of n){const p=o.trim();if(!p)continue;const f=p.match(/^(#{1,6})\s+(.*)$/);if(f){const w=f[2].trim().replace(/\s*-\s*$/,"");if(w){i={id:"root",text:w,level:0,children:[],expanded:!0};break}}}const u=[{node:i,minLevel:0}];let s=0,c=0,a=!0;for(const o of n){const p=o.trim();if(!p)continue;const f=p.match(/^(#{1,6})\s+(.*)$/);if(f){const g=f[1].length,x=f[2].trim().replace(/\s*-\s*$/,"");if(x){if(a){a=!1,c=g;continue}ce(x,g,u,s++),c=g}continue}const w=p.match(/^[-*]\s+(.*)$/);if(w){const g=w[1].trim(),x=xe(o);if(g){const v=c+x+1;ce(g,v,u,s++)}continue}if(!p.startsWith("#")&&!p.startsWith("-")&&!p.startsWith("*")){const g=xe(o);if(g>0&&p){const x=c+g;ce(p,x,u,s++)}}}return i}function xe(t){var c;const n=((c=t.match(/^(\s*)/))==null?void 0:c[1])||"",i=(n.match(/\t/g)||[]).length,u=n.replace(/\t/g,"").length;return i*2+Math.floor(u/2)}function ce(t,n,i,u){for(;i.length>1&&i[i.length-1].minLevel>=n;)i.pop();const c=i[i.length-1].node,a={id:`node-${u}`,text:t,level:n,children:[],expanded:!1};c.children.push(a),i.push({node:a,minLevel:n})}function ge(t){const n=[t];for(const i of t.children)n.push(...ge(i));return n}function ue(t,n={}){const{direction:i="both",horizontalSpacing:u=140,verticalSpacing:s=16,nodeWidth:c=100,nodeHeight:a=32,centerOffset:o=0,levelSpacingMultiplier:p=.85}=n,f=new Map,w=ge(t),g=De(w);return i==="both"?We(t,f,g,{horizontalSpacing:u,verticalSpacing:s,centerOffset:o,levelSpacingMultiplier:p}):Re(t,f,g,{horizontalSpacing:u,verticalSpacing:s,direction:i,levelSpacingMultiplier:p}),f}function Be(t){switch(t){case 0:return{chineseWidth:22,englishWidth:12,padding:56,baseHeight:52};case 1:return{chineseWidth:18,englishWidth:10,padding:28,baseHeight:36};case 2:return{chineseWidth:16,englishWidth:9,padding:24,baseHeight:32};case 3:return{chineseWidth:14,englishWidth:8,padding:20,baseHeight:30};default:return{chineseWidth:13,englishWidth:7,padding:20,baseHeight:28}}}function De(t,n,i){const u=new Map;for(const s of t){const c=s.text,a=Be(s.level);let o=0;for(const w of c)/[\u4e00-\u9fa5\u3000-\u303f\uff00-\uffef]/.test(w)?o+=a.chineseWidth:o+=a.englishWidth;o+=a.padding,o=Math.max(60,o);const p=s.id==="root";let f;if(p)f=a.baseHeight;else{const w=a.baseHeight;let g=0;o>180&&(o<=350?g=Math.floor((o-180)/12):g=14+Math.floor((o-350)/10)),f=w+g}u.set(s.id,{width:o,height:f})}return u}function We(t,n,i,u){const{horizontalSpacing:s,verticalSpacing:c,centerOffset:a}=u,o=i.get(t.id);if(n.set(t.id,{id:t.id,text:t.text,x:a,y:0,width:o.width,height:o.height,level:t.level,hasChildren:t.children.length>0,expanded:t.expanded||!1}),t.children.length===0)return;const p=t.children,f=Math.ceil(p.length/2),w=p.slice(0,f),g=p.slice(f);if(w.length>0){let v=-oe(w,i,c)/2;const j=a-o.width/2-s*.5;for(const h of w){const S=i.get(h.id),E=re(h,i,c),W=j-S.width/2,L=v+E/2;n.set(h.id,{id:h.id,text:h.text,x:W,y:L,width:S.width,height:S.height,level:h.level,hasChildren:h.children.length>0,expanded:h.expanded||!1,parentId:t.id}),h.expanded&&h.children.length>0&&ie(h,n,i,W,L,"left",s,c),v+=E+c}}if(g.length>0){let v=-oe(g,i,c)/2;const j=a+o.width/2+s*.5;for(const h of g){const S=i.get(h.id),E=re(h,i,c),W=j+S.width/2,L=v+E/2;n.set(h.id,{id:h.id,text:h.text,x:W,y:L,width:S.width,height:S.height,level:h.level,hasChildren:h.children.length>0,expanded:h.expanded||!1,parentId:t.id}),h.expanded&&h.children.length>0&&ie(h,n,i,W,L,"right",s,c),v+=E+c}}}function Re(t,n,i,u){const{horizontalSpacing:s,verticalSpacing:c,direction:a}=u,o=i.get(t.id);n.set(t.id,{id:t.id,text:t.text,x:0,y:0,width:o.width,height:o.height,level:t.level,hasChildren:t.children.length>0,expanded:t.expanded||!1}),ie(t,n,i,0,0,a,s,c)}function ie(t,n,i,u,s,c,a,o){if(!t.expanded||t.children.length===0)return;const p=c==="left"?-1:1,f=i.get(t.id),w=t.level>=2?1:.8,g=a*w*.6,x=u+p*(f.width/2+g),v=oe(t.children,i,o);let j=s-v/2;for(const h of t.children){const S=i.get(h.id),E=re(h,i,o),W=j+E/2,L=x+p*(S.width/2);n.set(h.id,{id:h.id,text:h.text,x:L,y:W,width:S.width,height:S.height,level:h.level,hasChildren:h.children.length>0,expanded:h.expanded||!1,parentId:t.id}),h.expanded&&h.children.length>0&&ie(h,n,i,L,W,c,a,o),j+=E+o}}function oe(t,n,i){if(t.length===0)return 0;let u=0;for(const c of t)u+=re(c,n,i);const s=i;return u+=(t.length-1)*s,u}function re(t,n,i){const s=n.get(t.id).height,c=Math.max(s,32);if(t.expanded&&t.children.length>0){const a=oe(t.children,n,i);return Math.max(c,a)}return c}function He(t,n){const i=n.x<t.x,u=t.id==="root",s=i?t.x-t.width/2:t.x+t.width/2,c=u?t.y:t.y+t.height/2,a=i?n.x+n.width/2:n.x-n.width/2,o=n.y+n.height/2,f=Math.abs(a-s)*.5,w=i?s-f:s+f,g=c,x=i?a+f:a-f;return`M ${s} ${c} C ${w} ${g}, ${x} ${o}, ${a} ${o}`}function fe(t){let n=1/0,i=-1/0,u=1/0,s=-1/0;return t.forEach(c=>{n=Math.min(n,c.x-c.width/2),i=Math.max(i,c.x+c.width/2),u=Math.min(u,c.y-c.height/2),s=Math.max(s,c.y+c.height/2)}),{minX:n,maxX:i,minY:u,maxY:s,width:i-n,height:s-u}}const Ne=({markdown:t,onNodeClick:n,layoutOptions:i={},styleName:u="modern"})=>{const s=m.useRef(null),c=m.useRef(null),a=m.useRef({isDragging:!1,startX:0,startY:0,offsetX:0,offsetY:0}),[o,p]=m.useState(null),[f,w]=m.useState(new Map),[,g]=m.useState(null),[x,v]=m.useState(1),[j,h]=m.useState({x:0,y:0}),[S,E]=m.useState("move"),[W,L]=m.useState(!1),[R,J]=m.useState(!1),[P,O]=m.useState(null),K=r=>({id:r.id,text:r.text,level:r.level,children:r.children.map(K),expanded:r.expanded!==!1});m.useEffect(()=>{if(!t){p(null);return}const r=Ee(t),d=K(r);p(d)},[t]),m.useEffect(()=>{if(!o)return;const d={...{direction:"right",horizontalSpacing:140,verticalSpacing:20,nodeWidth:100,nodeHeight:32,centerOffset:0,levelSpacingMultiplier:.85},...i},l=ue(o,d);if(w(l),!R){const b=fe(l),M=s.current;if(M&&b.width>0&&b.height>0){const y=M.clientWidth,D=M.clientHeight;let B=1/0,H=-1/0;l.forEach(X=>{X.level<=1&&(B=Math.min(B,X.y-X.height/2),H=Math.max(H,X.y+X.height/2))});const z=H-B,T=100;let N=1;z>0&&(N=(D-T)/z),N=Math.min(1.5,Math.max(.5,N)),v(N);let I=0;l.forEach(X=>{X.x<I&&(I=X.x)});const U=Math.abs(Math.min(0,b.minX))*N+50;let A=Math.max(y*.2,U);const Z=D*.5;h({x:A,y:Z}),J(!0)}}},[o,i,R]);const _=m.useCallback((r,d)=>{if(r.id===d)return r;for(const l of r.children){const b=_(l,d);if(b)return b}return null},[]),k=m.useCallback((r,d,l)=>r.id===d?{...r,expanded:l}:{...r,children:r.children.map(b=>k(b,d,l))},[]),C=m.useCallback((r,d)=>{d.stopPropagation(),d.preventDefault(),g(r.id),n==null||n(r),r.children.length>0&&(r.expanded||O(r.id),p(l=>l?k(l,r.id,!r.expanded):null))},[n,k]),q=m.useCallback(r=>{r.button===0&&(a.current.isDragging=!0,a.current.startX=r.clientX,a.current.startY=r.clientY,a.current.offsetX=j.x,a.current.offsetY=j.y,L(!0))},[j]);m.useEffect(()=>{const r=l=>{if(!a.current.isDragging)return;const b=l.clientX-a.current.startX,M=l.clientY-a.current.startY;h({x:a.current.offsetX+b,y:a.current.offsetY+M})},d=()=>{a.current.isDragging=!1,L(!1)};return document.addEventListener("mousemove",r),document.addEventListener("mouseup",d),()=>{document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",d)}},[]);const pe=m.useCallback(r=>{if(r.preventDefault(),S==="move"){let d=r.deltaX,l=r.deltaY;r.shiftKey&&d===0&&(d=l,l=0),h(b=>({x:b.x-d,y:b.y-l}))}else{const d=r.deltaY>0?.9:1.1,l=Math.max(.1,Math.min(5,x*d));if(l!==x&&s.current){const b=s.current.getBoundingClientRect(),M=r.clientX-b.left,y=r.clientY-b.top,D=(M-j.x)/x,B=(y-j.y)/x;v(l),h({x:M-D*l,y:y-B*l})}}},[S,x,j]);m.useEffect(()=>{if(!P||!o||f.size===0||!s.current)return;const r=_(o,P);if(!r||!r.children.length){O(null);return}const d=r.children[0].id;if(!f.has(d))return;const l=f.get(P);if(!l)return;const b=new Set,M=F=>{b.add(F.id),F.expanded&&F.children.forEach(M)};M(r);let y=1/0,D=-1/0,B=1/0,H=-1/0;if(b.forEach(F=>{const $=f.get(F);$&&(y=Math.min(y,$.x-$.width/2),D=Math.max(D,$.x+$.width/2),B=Math.min(B,$.y-$.height/2),H=Math.max(H,$.y+$.height/2))}),y===1/0){O(null);return}const z=s.current,T=z.clientWidth,N=z.clientHeight,I=50,U=I-y*x,A=T-I-D*x,Z=I-B*x,X=N-I-H*x;let Y=j.x,V=j.y;const ve=D-l.x>l.x-y;if(U<=A){const F=y*x+j.x,$=D*x+j.x;F<I?Y=U:$>T-I&&(Y=A)}else ve?(Y=A,l.x*x+Y<I&&(Y=I-l.x*x)):(Y=U,l.x*x+Y>T-I&&(Y=T-I-l.x*x));const de=B*x+j.y,je=H*x+j.y;de<I?V=Z:je>N-I&&de>I&&(V=X,B*x+V<I&&(V=Z)),(Math.abs(Y-j.x)>1||Math.abs(V-j.y)>1)&&h({x:Y,y:V}),O(null)},[f,P,x,j,o,_]);const Q=m.useCallback(()=>{if(o){const d={...{direction:"right",horizontalSpacing:140,verticalSpacing:20,nodeWidth:100,nodeHeight:32,centerOffset:0,levelSpacingMultiplier:.85},...i},l=ue(o,d),b=fe(l),M=s.current;if(M&&b.width>0&&b.height>0){const y=M.clientWidth,D=M.clientHeight;let B=1/0,H=-1/0;l.forEach(A=>{A.level<=1&&(B=Math.min(B,A.y-A.height/2),H=Math.max(H,A.y+A.height/2))});const z=H-B,T=100;let N=1;z>0&&(N=(D-T)/z),N=Math.min(1.5,Math.max(.5,N)),v(N);const I=Math.abs(Math.min(0,b.minX))*N+50;let U=Math.max(y*.2,I);h({x:U,y:D*.5})}}},[o,i]);m.useEffect(()=>{const r=s.current;if(!r)return;const d=l=>{switch(l.key){case"PageUp":l.preventDefault(),h(y=>({...y,y:y.y+300}));break;case"PageDown":l.preventDefault(),h(y=>({...y,y:y.y-300}));break;case"ArrowUp":l.preventDefault(),h(y=>({...y,y:y.y+50}));break;case"ArrowDown":l.preventDefault(),h(y=>({...y,y:y.y-50}));break;case"ArrowLeft":l.preventDefault(),h(y=>({...y,x:y.x+50}));break;case"ArrowRight":l.preventDefault(),h(y=>({...y,x:y.x-50}));break;case"Home":l.preventDefault(),Q();break}};return r.addEventListener("keydown",d),()=>{r.removeEventListener("keydown",d)}},[Q]),m.useEffect(()=>{const r=s.current;r&&R&&requestAnimationFrame(()=>{r.focus()})},[R]);const me=m.useCallback(()=>{if(!o)return;const r=d=>({...d,expanded:!0,children:d.children.map(r)});p(r(o))},[o]),ye=m.useCallback(()=>{if(!o)return;const r=d=>({...d,expanded:!1,children:d.children.map(r)});p(r(o))},[o]),se=m.useCallback(r=>{if(!o||r==="root")return-1;for(let d=0;d<o.children.length;d++){const l=(b,M)=>b.id===M?!0:b.children.some(y=>l(y,M));if(l(o.children[d],r))return d%5}return-1},[o]),we=m.useMemo(()=>{const r=[],d=new Map;return f.forEach(l=>{if(l.parentId){const b=d.get(l.parentId)||[];b.push(l),d.set(l.parentId,b)}}),d.forEach((l,b)=>{f.get(b)&&l.length>=2}),f.forEach((l,b)=>{if(l.parentId){const M=f.get(l.parentId);if(M){const y=He(M,l),D=se(b),B=l.level;r.push(e.jsx("path",{d:y,className:`mm-link branch-${D} level-${B}`},`link-${b}`))}}}),r},[f,se]),ae=m.useMemo(()=>{if(!o)return new Map;const r=new Map,d=l=>{r.set(l.id,l),l.children.forEach(d)};return d(o),r},[o]),be=m.useMemo(()=>{if(!o||f.size===0)return[];const r=[];return f.forEach(d=>{const l=d.id==="root",b=d.hasChildren,M=se(d.id),y=ae.get(d.id);if(!y)return;const D=y.expanded,H=((z,T)=>{if(T)return 52;switch(z){case 1:return 36;case 2:return 32;case 3:return 30;default:return 28}})(d.level,l);r.push(e.jsxs("div",{className:`mm-node ${l?"root":""} branch-${M} style-${u}`,style:{left:d.x-d.width/2,top:d.y-H/2,width:d.width,height:H},"data-level":d.level,onClick:z=>C(y,z),title:d.text,children:[e.jsx("span",{className:"mm-node-text",children:d.text}),!l&&e.jsx("div",{className:"mm-node-underline"}),b&&!D&&e.jsx("span",{className:"mm-collapse-indicator",children:"+"})]},d.id))}),r},[f,ae,C]);return o?e.jsxs("div",{className:`mm-container style-${u}`,ref:s,tabIndex:0,onFocus:r=>{r.currentTarget.style.outline="none"},children:[e.jsxs("div",{className:"mm-toolbar",children:[e.jsx("button",{onClick:me,title:"展开所有",children:"展开"}),e.jsx("button",{onClick:ye,title:"折叠所有",children:"折叠"}),e.jsx("button",{onClick:Q,title:"重置视图",children:"重置"}),e.jsxs("div",{className:"mm-mode-toggle",children:[e.jsx("button",{className:`mm-mode-btn ${S==="move"?"active":""}`,onClick:()=>E("move"),title:"移动模式 (滚轮移动画布)",children:"移动"}),e.jsx("button",{className:`mm-mode-btn ${S==="zoom"?"active":""}`,onClick:()=>E("zoom"),title:"缩放模式 (滚轮缩放画布)",children:"缩放"})]})]}),e.jsx("div",{className:`mm-canvas ${W?"grabbing":"grab"}`,onMouseDown:q,onWheel:pe,onDoubleClick:Q,children:e.jsxs("div",{style:{width:"100%",height:"100%",transform:`translate(${j.x}px, ${j.y}px) scale(${x})`,transformOrigin:"0 0",position:"absolute",top:0,left:0},children:[e.jsx("svg",{ref:c,className:"mm-svg",style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",overflow:"visible"},children:we}),e.jsx("div",{className:"mm-nodes",children:be})]})})]}):e.jsx("div",{className:"mm-container",children:e.jsx("div",{className:"mm-empty",children:"暂无思维导图内容"})})},ze=()=>e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("circle",{cx:"12",cy:"12",r:"3"}),e.jsx("circle",{cx:"4",cy:"6",r:"2"}),e.jsx("circle",{cx:"20",cy:"6",r:"2"}),e.jsx("circle",{cx:"4",cy:"18",r:"2"}),e.jsx("circle",{cx:"20",cy:"18",r:"2"}),e.jsx("path",{d:"M9.5 10.5L6 8M14.5 10.5L18 8M9.5 13.5L6 16M14.5 13.5L18 16"})]}),Ae=()=>e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M14 3v4a1 1 0 0 0 1 1h4"}),e.jsx("path",{d:"M17 21H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7l5 5v11a2 2 0 0 1-2 2z"}),e.jsx("path",{d:"M9 15l2-2 2 2"}),e.jsx("path",{d:"M11 13v4"})]}),$e=()=>e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{x:"9",y:"9",width:"13",height:"13",rx:"2",ry:"2"}),e.jsx("path",{d:"M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"})]}),Te=()=>e.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polyline",{points:"20 6 9 17 4 12"})}),Xe=()=>e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}),e.jsx("polyline",{points:"7 10 12 15 17 10"}),e.jsx("line",{x1:"12",y1:"15",x2:"12",y2:"3"})]}),Ye=()=>e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]}),Fe=()=>e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("circle",{cx:"13.5",cy:"6.5",r:"0.5",fill:"currentColor"}),e.jsx("circle",{cx:"17.5",cy:"10.5",r:"0.5",fill:"currentColor"}),e.jsx("circle",{cx:"8.5",cy:"7.5",r:"0.5",fill:"currentColor"}),e.jsx("circle",{cx:"6.5",cy:"12.5",r:"0.5",fill:"currentColor"}),e.jsx("path",{d:"M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.555C21.965 6.012 17.461 2 12 2z"})]}),Pe=({mindmapData:t,onClose:n,onRetry:i})=>{var P,O,K,_;const[u,s]=m.useState("mindmap"),[c,a]=m.useState("modern"),[o,p]=m.useState(!1),[f,w]=m.useState(!1),[g]=m.useState(null);ke.useEffect(()=>{const k=C=>{C.key==="Escape"&&n()};return window.addEventListener("keydown",k),()=>{window.removeEventListener("keydown",k)}},[n]);const x=g&&(((P=t.errorMessage)==null?void 0:P.includes("失败"))||((O=t.errorMessage)==null?void 0:O.includes("错误"))||((K=t.errorMessage)==null?void 0:K.includes("超时"))||((_=t.errorMessage)==null?void 0:_.includes("为空"))||t.mindmapMarkdown.trim().length===0),v=t.mindmapMarkdown.trim(),j=v.length>0&&!t.errorMessage,S=(k=>{let C=k.trim();return C.startsWith("```markdown")?C=C.replace(/^```markdown\n?/,""):C.startsWith("```")&&(C=C.replace(/^```\n?/,"")),C.endsWith("```")&&(C=C.replace(/\n?```$/,"")),C.trim()})(v),E=async()=>{try{await navigator.clipboard.writeText(S),p(!0),setTimeout(()=>p(!1),2e3)}catch(k){console.error("Copy failed:",k)}},W=()=>{const k=new Blob([S],{type:"text/markdown"}),C=URL.createObjectURL(k),q=document.createElement("a");q.href=C,q.download=`${t.videoTitle}_思维导图.md`,q.click(),URL.revokeObjectURL(C)},L=[{value:"modern",label:"现代简约"},{value:"classic",label:"经典商务"},{value:"dark",label:"极客深色"},{value:"colorful",label:"活泼五彩"},{value:"handdrawn",label:"趣味手绘"}],R={width:"36px",height:"36px",display:"flex",alignItems:"center",justifyContent:"center",border:"none",borderRadius:"8px",background:"rgba(255, 255, 255, 0.9)",color:"#374151",cursor:"pointer",transition:"all 0.2s ease",boxShadow:"0 2px 8px rgba(0, 0, 0, 0.1)"},J={...R,background:"#3b82f6",color:"white"};return e.jsxs("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"white",zIndex:999999,display:"flex",flexDirection:"column"},children:[e.jsxs("div",{style:{position:"absolute",top:"16px",left:"16px",display:"flex",gap:"8px",alignItems:"center",zIndex:1e3,padding:"8px",background:"rgba(255, 255, 255, 0.95)",backdropFilter:"blur(10px)",borderRadius:"12px",boxShadow:"0 4px 20px rgba(0, 0, 0, 0.1)",border:"1px solid rgba(255, 255, 255, 0.5)"},children:[e.jsx("button",{onClick:()=>s("mindmap"),style:u==="mindmap"?J:R,title:"思维导图视图",children:e.jsx(ze,{})}),e.jsx("button",{onClick:()=>s("markdown"),style:u==="markdown"?J:R,title:"Markdown视图",children:e.jsx(Ae,{})}),e.jsx("div",{style:{width:"1px",height:"24px",background:"#e5e7eb",margin:"0 4px"}}),u==="mindmap"&&e.jsxs("div",{style:{position:"relative"},children:[e.jsx("button",{onClick:()=>w(!f),style:R,title:"切换样式",children:e.jsx(Fe,{})}),f&&e.jsx("div",{style:{position:"absolute",top:"44px",left:"0",background:"white",borderRadius:"8px",boxShadow:"0 4px 20px rgba(0, 0, 0, 0.15)",border:"1px solid #e5e7eb",overflow:"hidden",minWidth:"120px"},children:L.map(k=>e.jsx("div",{onClick:()=>{a(k.value),w(!1)},style:{padding:"10px 16px",cursor:"pointer",fontSize:"13px",color:c===k.value?"#3b82f6":"#374151",background:c===k.value?"#eff6ff":"transparent",fontWeight:c===k.value?500:400,transition:"background 0.2s"},onMouseEnter:C=>{c!==k.value&&(C.currentTarget.style.background="#f3f4f6")},onMouseLeave:C=>{c!==k.value&&(C.currentTarget.style.background="transparent")},children:k.label},k.value))})]}),e.jsx("button",{onClick:E,style:o?{...R,background:"#10b981",color:"white"}:R,title:o?"已复制":"复制Markdown",children:o?e.jsx(Te,{}):e.jsx($e,{})}),e.jsx("button",{onClick:W,style:R,title:"下载Markdown文件",children:e.jsx(Xe,{})})]}),e.jsx("div",{style:{position:"absolute",top:"16px",right:"16px",zIndex:1e3},children:e.jsx("button",{onClick:n,style:{...R,background:"#fee2e2",color:"#dc2626",boxShadow:"0 4px 20px rgba(0, 0, 0, 0.1)",border:"1px solid rgba(255, 255, 255, 0.5)"},onMouseEnter:k=>{k.currentTarget.style.background="#fecaca"},onMouseLeave:k=>{k.currentTarget.style.background="#fee2e2"},title:"关闭",children:e.jsx(Ye,{})})}),f&&e.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,zIndex:999},onClick:()=>w(!1)}),e.jsx("div",{style:{flex:1,overflow:"auto"},children:u==="mindmap"?g&&x?e.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",minHeight:"100%",padding:"40px"},children:[e.jsxs("svg",{width:"64",height:"64",viewBox:"0 0 24 24",fill:"none",stroke:"#ef4444",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",style:{marginBottom:"20px"},children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("line",{x1:"12",y1:"8",x2:"12",y2:"12"}),e.jsx("line",{x1:"12",y1:"16",x2:"12.01",y2:"16"})]}),e.jsx("h3",{style:{color:"#991b1b",fontSize:"20px",margin:"0 0 15px",fontWeight:600},children:"思维导图生成失败"}),e.jsx("div",{style:{background:"#fef2f2",border:"1px solid #fecaca",borderRadius:"8px",padding:"15px",maxWidth:"500px",width:"100%",marginBottom:"20px"},children:e.jsx("p",{style:{color:"#991b1b",fontSize:"14px",lineHeight:"1.6",margin:0},children:g})}),e.jsxs("div",{style:{display:"flex",gap:"10px"},children:[e.jsx("button",{onClick:n,style:{padding:"10px 20px",border:"1px solid #d1d5db",borderRadius:"6px",background:"white",color:"#374151",cursor:"pointer",fontSize:"14px"},children:"关闭"}),i&&e.jsx("button",{onClick:i,style:{padding:"10px 20px",border:"none",borderRadius:"6px",background:"#3b82f6",color:"white",cursor:"pointer",fontSize:"14px"},children:"重新生成"})]}),e.jsxs("div",{style:{marginTop:"30px",padding:"15px",background:"#f3f4f6",borderRadius:"8px",maxWidth:"500px",width:"100%"},children:[e.jsx("h4",{style:{color:"#374151",fontSize:"14px",margin:"0 0 10px",fontWeight:600},children:"可能的解决方案："}),e.jsxs("ul",{style:{color:"#6b7280",fontSize:"13px",lineHeight:"1.8",margin:0,paddingLeft:"20px"},children:[e.jsx("li",{children:"检查API密钥和API地址配置是否正确"}),e.jsx("li",{children:"确认网络连接是否正常"}),e.jsx("li",{children:"稍后重试，可能是API服务暂时不可用"}),e.jsx("li",{children:"尝试简化字幕内容后重新生成"})]})]})]}):g?e.jsxs("div",{style:{color:"#ef4444",textAlign:"center",padding:"40px"},children:[e.jsx("p",{style:{fontSize:"16px",marginBottom:"20px"},children:g}),e.jsx("p",{style:{fontSize:"14px",color:"#6b7280"},children:'点击上方的"Markdown"按钮可查看原文'})]}):j?e.jsx("div",{style:{width:"100%",height:"100%"},children:e.jsx(Ne,{markdown:S,styleName:c,onNodeClick:k=>{console.log("Node clicked:",k)}})}):e.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",minHeight:"100%",padding:"40px"},children:[e.jsxs("svg",{width:"64",height:"64",viewBox:"0 0 24 24",fill:"none",stroke:"#94a3b8",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",style:{marginBottom:"20px"},children:[e.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",ry:"2"}),e.jsx("line",{x1:"12",y1:"8",x2:"12",y2:"16"}),e.jsx("line",{x1:"8",y1:"12",x2:"16",y2:"12"})]}),e.jsx("h3",{style:{color:"#374151",fontSize:"20px",margin:"0 0 15px",fontWeight:600},children:"暂无思维导图内容"}),e.jsx("div",{style:{background:"#f3f4f6",border:"1px solid #e5e7eb",borderRadius:"8px",padding:"15px",maxWidth:"500px",width:"100%",marginBottom:"20px"},children:e.jsx("p",{style:{color:"#6b7280",fontSize:"14px",lineHeight:"1.6",margin:0},children:t.errorMessage||"请先从字幕生成思维导图"})}),e.jsxs("div",{style:{display:"flex",gap:"10px"},children:[e.jsx("button",{onClick:n,style:{padding:"10px 20px",border:"1px solid #d1d5db",borderRadius:"6px",background:"white",color:"#374151",cursor:"pointer",fontSize:"14px"},children:"关闭"}),i&&e.jsx("button",{onClick:i,style:{padding:"10px 20px",border:"none",borderRadius:"6px",background:"#3b82f6",color:"white",cursor:"pointer",fontSize:"14px"},children:"重新生成"})]})]}):e.jsx("pre",{style:{margin:0,padding:"20px",background:"#f9fafb",fontSize:"14px",lineHeight:"1.6",whiteSpace:"pre-wrap",wordWrap:"break-word",minHeight:"100%"},children:S})})]})};function Oe(){const t=document.createElement("div");t.id="mindmap-floating-ball-container",document.body.appendChild(t),Me(t).render(e.jsx(Ue,{}))}function Ue(){const[t,n]=m.useState(!1),[i,u]=m.useState(!1),[s,c]=m.useState(null),[a,o]=m.useState(),p=m.useCallback(async()=>{var g;try{const x=await chrome.runtime.sendMessage({type:"GET_CURRENT_TASK"});if(x&&x.task){const v=x.task;let j;v.data&&(j=v.data.videoTitle||((g=v.data.subtitleText)==null?void 0:g.substring(0,30))||"处理中...");const h={type:v.type,status:v.status,videoTitle:j,result:v.result,errorMessage:v.error};o(h),v.status==="completed"&&!t&&!i&&n(!0)}else o(void 0)}catch(x){console.error("[FloatingBall] Failed to get current task:",x),o(void 0)}},[t,i]);m.useEffect(()=>{const g=E=>{var W;if(E.type==="MINDMAP_GENERATED"){const L=(W=E.payload)==null?void 0:W.mindmapData;L&&(c(L),n(!0)),p()}};chrome.runtime.onMessage.addListener(g);const x=E=>{var R;const L=(R=E.detail)==null?void 0:R.mindmapData;L&&(c(L),n(!0)),p()};window.addEventListener("mindmap-generated",x);let v=window.location.href;const j=()=>{window.location.href!==v&&(v=window.location.href,c(null),u(!1),n(!1))},h=new MutationObserver(j);h.observe(document.body,{childList:!0,subtree:!0}),p();const S=setInterval(p,1e3);return()=>{chrome.runtime.onMessage.removeListener(g),window.removeEventListener("mindmap-generated",x),clearInterval(S),h.disconnect()}},[p]);const f=async()=>{if(n(!1),console.log("[FloatingBall] 点击悬浮球，当前任务状态:",a),console.log("[FloatingBall] 当前页面URL:",window.location.href),(a==null?void 0:a.status)==="completed"&&a.result){console.log("[FloatingBall] 使用当前任务的结果"),c(a.result),u(!0);return}try{console.log("[FloatingBall] 尝试获取当前URL的思维导图");const g=await chrome.runtime.sendMessage({type:"GET_LATEST_MINDMAP_BY_URL",payload:{videoUrl:window.location.href}});if(console.log("[FloatingBall] GET_LATEST_MINDMAP_BY_URL 响应:",g),g&&g.mindmap)console.log("[FloatingBall] 找到匹配的思维导图"),c(g.mindmap),u(!0);else{console.log("[FloatingBall] 未找到匹配的思维导图，尝试获取最新的");const x=await chrome.runtime.sendMessage({type:"GET_LATEST_MINDMAP"});console.log("[FloatingBall] GET_LATEST_MINDMAP 响应:",x),x&&x.mindmap?(console.log("[FloatingBall] 找到最新的思维导图"),c(x.mindmap),u(!0)):(a==null?void 0:a.status)==="running"?(console.log("[FloatingBall] 任务正在运行中"),alert("任务正在进行中，请稍候...")):(console.log("[FloatingBall] 没有找到任何思维导图数据"),alert("暂无该视频的思维导图内容，请点击下载字幕生成"))}}catch(g){console.error("[FloatingBall] 获取思维导图失败:",g)}},w=()=>{u(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(Ie,{showNotification:t,currentTask:a,onClick:f}),i&&s&&e.jsx(Pe,{mindmapData:s,onClose:w})]})}console.log("[Content] Script loaded");Ce();Oe();chrome.runtime.onMessage.addListener(t=>{switch(console.log("[Content] Received message:",t),t.type){case"MINDMAP_GENERATED":_e();break}});function _e(){const t=new CustomEvent("mindmap-generated");window.dispatchEvent(t)}
