class w{static buildPrompt(e,t){return e.replace("{subtitle_content}",t)}static async fetchWithTimeout(e,t,s=3e4){console.log(`[LLMService] 发起请求: ${e}, 超时: ${s/1e3}s`);const r=new Promise((i,n)=>{setTimeout(()=>{n(new Error(`请求超时（${s/1e3}秒），请检查网络连接或API服务是否正常`))},s)});try{const i=await Promise.race([fetch(e,t),r]);return console.log(`[LLMService] 响应状态: ${i.status}`),i}catch(i){throw console.error("[LLMService] 请求失败:",i),i.name==="TypeError"&&i.message==="Failed to fetch"?new Error(`网络请求失败：无法连接到 ${new URL(e).hostname}，请检查网络连接和API地址`):i}}static parseError(e){let t="";if(e instanceof Error){t=e.message||e.name||"Unknown Error";const s=e;s.cause&&(t+=` (${String(s.cause)})`)}else typeof e=="string"?t=e:e&&typeof e=="object"?t=e.message||e.error||JSON.stringify(e):t=String(e)||"Unknown Error";return(!t||t==="Error"||t==="undefined"||t==="null")&&(t="未知错误，请检查网络连接和API配置"),t.includes("fetch")||t.includes("网络")||t.includes("Failed to fetch")||t.includes("NetworkError")?"网络错误：无法连接到API服务器，请检查网络连接和API地址是否正确":t.includes("超时")||t.includes("timeout")||t.includes("Timeout")||t.includes("AbortError")?`请求超时：${t}`:t.includes("CORS")||t.includes("cross-origin")||t.includes("Access-Control")?"跨域错误：API服务器不允许跨域请求，请检查API配置":t.includes("API")||t.includes("api")||t.includes("401")||t.includes("403")||t.includes("429")?`API错误：${t}`:t.includes("为空")||t.includes("empty")||t.includes("no content")?"大模型返回内容为空：请检查Prompt模板或尝试重新生成":`调用大模型失败：${t}`}static async generateMindmap(e,t){const s=this.buildPrompt(e.prompt.template,t),r=(Number(e.llm.timeout)||60)*1e3;try{let i;if(e.llm.provider==="gemini"?i=await this.callGeminiAPI(e,s,r):i=await this.callOpenAICompatibleAPI(e,s,r),console.log("[LLMService] 成功获取大模型响应"),!i||typeof i!="string"||i.trim().length===0)throw new Error("大模型返回的内容为空或不合法");return i}catch(i){const n=this.parseError(i);throw console.error("调用大模型API失败:",i),new Error(n)}}static buildOpenAIUrl(e,t){if(!e)return"";let s=e.trim();return s.endsWith("/")&&(s=s.slice(0,-1)),t==="openai"&&!s.endsWith("/chat/completions")&&(s=s+"/chat/completions"),s}static async callOpenAICompatibleAPI(e,t,s){var d,p,f,P,A;const r=this.buildOpenAIUrl(e.llm.apiUrl,e.llm.provider);console.log("[LLMService] 正在发起 OpenAI 兼容请求:"),console.log(`[LLMService] - URL: ${r}`),console.log(`[LLMService] - Model: ${e.llm.model.trim()}`),console.log(`[LLMService] - API Key: ${e.llm.apiKey?e.llm.apiKey.substring(0,8)+"...":"(空)"}`),console.log(`[LLMService] - API Key 长度: ${((d=e.llm.apiKey)==null?void 0:d.length)||0}`);const i={model:e.llm.model.trim(),messages:[{role:"user",content:t}],temperature:.7,max_tokens:2e3};console.log(`[LLMService] - Request body size: ${JSON.stringify(i).length} bytes`);const n=await this.fetchWithTimeout(r,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json",Authorization:`Bearer ${e.llm.apiKey.trim()}`},body:JSON.stringify(i)},s);let o;const a=await n.text();try{o=a?JSON.parse(a):{}}catch{throw console.error("[LLMService] Failed to parse JSON response:",a),new Error(`API 响应格式错误 (HTTP ${n.status}): ${a.substring(0,100)}`)}if(!n.ok){const l=n.status;console.error(`[LLMService] API 错误响应 (${l}):`,a),console.error("[LLMService] 解析后的错误数据:",o);let c=((p=o.error)==null?void 0:p.message)||o.message||o.detail||"";typeof o.error=="string"&&(c=o.error);let m=c||"调用大模型API失败";throw l===401?m=c||"API密钥无效或已过期，请检查配置":l===403?m=c||"API访问被拒绝，请检查API权限":l===429?m=c||"API请求过于频繁，请稍后重试":l>=500&&(m=c||`API服务器错误（${l}），请稍后重试`),new Error(`HTTP ${l}: ${m}`)}const u=(A=(P=(f=o.choices)==null?void 0:f[0])==null?void 0:P.message)==null?void 0:A.content;if(!u)throw new Error("API返回的数据格式不正确");return u}static async callGeminiAPI(e,t,s){var P,A,l,c,m,y,L,g;console.log("[LLMService] 正在发起 Gemini 请求:"),console.log(`[LLMService] - API Key: ${e.llm.apiKey?e.llm.apiKey.substring(0,8)+"...":"(空)"}`),console.log(`[LLMService] - API Key 长度: ${((P=e.llm.apiKey)==null?void 0:P.length)||0}`);let r=e.llm.apiUrl.trim();r.endsWith("/")&&(r=r.slice(0,-1));const i=e.llm.model||"gemini-pro",n=r.includes("/models/"),o=r.includes(":generateContent");!n&&!o?r=`${r}/models/${i}:generateContent`:n&&!o&&(r=`${r}:generateContent`);const a=r.includes("?")?"&":"?";r.includes("key=")||(r=`${r}${a}key=${e.llm.apiKey}`);const u=await this.fetchWithTimeout(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:t}]}],generationConfig:{temperature:.7,maxOutputTokens:2e3}})},s);let d;const p=await u.text();try{d=p?JSON.parse(p):{}}catch{throw console.error("[LLMService] Failed to parse Gemini JSON response:",p),new Error(`Gemini API 响应格式错误 (HTTP ${u.status}): ${p.substring(0,100)}`)}if(!u.ok){const h=u.status;let I=((A=d.error)==null?void 0:A.message)||((l=d.error)==null?void 0:l.status)||"调用 Gemini API 失败";throw h===401?I="API密钥无效或已过期，请检查配置":h===403?I="API访问被拒绝，请检查API权限或配额":h===429?I="API请求过于频繁，请稍后重试":h>=500&&(I=`Gemini 服务器错误（${h}），请稍后重试`),new Error(I)}const f=(g=(L=(y=(m=(c=d.candidates)==null?void 0:c[0])==null?void 0:m.content)==null?void 0:y.parts)==null?void 0:L[0])==null?void 0:g.text;if(!f)throw new Error("Gemini API 返回的数据格式不正确");return f}static buildGeminiUrl(e,t,s=!1){if(!e)return"";let r=e.trim();r.endsWith("/")&&(r=r.slice(0,-1));const i=t||"gemini-pro",n=r.includes("/models/"),o=r.includes(":generateContent");!n&&!o?r=`${r}/models/${i}:generateContent`:n&&!o&&(r=`${r}:generateContent`);const a=r.includes("?")?"&":"?";return r.includes("key=")||(r=`${r}${a}key=${s?"{API_KEY}":"***"}`),r}static getFullRequestUrl(e,t,s){return t?e==="gemini"?this.buildGeminiUrl(t,s,!1):this.buildOpenAIUrl(t,e):""}static validateConfig(e){return e.llm.apiUrl?e.llm.apiKey?e.llm.model?e.prompt.template?{valid:!0}:{valid:!1,error:"Prompt模板不能为空"}:{valid:!1,error:"模型名称不能为空"}:{valid:!1,error:"API密钥不能为空"}:{valid:!1,error:"API地址不能为空"}}}export{w as L};
