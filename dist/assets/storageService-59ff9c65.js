function g(){return`llm_${Date.now()}_${Math.random().toString(36).substring(2,9)}`}function p(l="openai"){const t=Date.now(),e={openai:{name:"OpenAI GPT",provider:"openai",apiUrl:"https://api.openai.com/v1",model:"gpt-3.5-turbo"},gemini:{name:"Google Gemini",provider:"gemini",apiUrl:"https://generativelanguage.googleapis.com/v1beta",model:"gemini-1.5-flash"},custom:{name:"自定义配置",provider:"custom",apiUrl:"",model:""}};return{id:g(),...e[l],apiKey:"",timeout:60,createdAt:t,updatedAt:t}}const d={id:"default",name:"OpenAI GPT (默认)",provider:"openai",apiUrl:"https://api.openai.com/v1",apiKey:"",model:"gpt-3.5-turbo",timeout:60,createdAt:0,updatedAt:0},m={selectedLLMConfigId:"default",llm:{provider:"openai",apiUrl:"https://api.openai.com/v1",apiKey:"",model:"gpt-3.5-turbo",timeout:60},prompt:{template:`请将以下视频字幕内容总结为一个思维导图，使用纯Markdown格式。

要求：
1. 使用标准的Markdown标题层级（# 一级标题、## 二级标题等）表示思维导图结构
2. 使用无序列表（-）表示分支节点
3. 提取主要观点和关键信息
4. 保持逻辑层次清晰
5. 使用简洁的语言
6. 不要使用任何特殊语法或Mermaid

字幕内容：
{subtitle_content}

请直接输出Markdown格式的思维导图，不要包含其他说明文字。`},settings:{language:"zh-CN",cacheDirectory:"",enableCache:!0},exclusionKeywords:[]},n={CONFIG:"plugin_config",LLM_CONFIGS:"llm_configs",MINDMAPS:"mindmaps",LATEST_MINDMAP_ID:"latest_mindmap_id"};class f{static async getConfig(){const e=(await chrome.storage.sync.get(n.CONFIG))[n.CONFIG];return e?{...e,selectedLLMConfigId:e.selectedLLMConfigId||"default",llm:{...e.llm,timeout:e.llm.timeout||60},settings:{...e.settings,enableCache:e.settings.enableCache!==void 0?e.settings.enableCache:!0},exclusionKeywords:e.exclusionKeywords||[]}:null}static async saveConfig(t){await chrome.storage.sync.set({[n.CONFIG]:t})}static async getLLMConfigsRaw(){return(await chrome.storage.sync.get(n.LLM_CONFIGS))[n.LLM_CONFIGS]||[]}static async getLLMConfigs(){const t=await this.getLLMConfigsRaw();if(t.length===0){const e=await this.getConfig();if(e&&e.llm.apiKey){const i={id:"migrated_default",name:`${e.llm.provider==="openai"?"OpenAI":e.llm.provider==="gemini"?"Gemini":"自定义"} (已迁移)`,provider:e.llm.provider,apiUrl:e.llm.apiUrl,apiKey:e.llm.apiKey,model:e.llm.model,timeout:e.llm.timeout||60,createdAt:Date.now(),updatedAt:Date.now()};return await chrome.storage.sync.set({[n.LLM_CONFIGS]:[i]}),await this.saveConfig({...e,selectedLLMConfigId:i.id}),[i]}return[d]}return t}static async getLLMConfigById(t){return(await this.getLLMConfigs()).find(i=>i.id===t)||null}static async getSelectedLLMConfig(){const t=await this.getConfig(),e=(t==null?void 0:t.selectedLLMConfigId)||"default",i=await this.getLLMConfigs();return i.find(s=>s.id===e)||i[0]||null}static async saveLLMConfig(t){console.log("[StorageService] saveLLMConfig: 开始保存",t);let e=await this.getLLMConfigsRaw();(!e||e.length===0)&&(e=[]),console.log("[StorageService] saveLLMConfig: 当前配置列表",e);const i=e.findIndex(a=>a.id===t.id);console.log("[StorageService] saveLLMConfig: existingIndex =",i),i>=0?(e[i]={...t,updatedAt:Date.now()},console.log("[StorageService] saveLLMConfig: 更新现有配置")):(e.push({...t,updatedAt:Date.now()}),console.log("[StorageService] saveLLMConfig: 添加新配置")),console.log("[StorageService] saveLLMConfig: 准备保存的配置列表",e),await chrome.storage.sync.set({[n.LLM_CONFIGS]:e}),console.log("[StorageService] saveLLMConfig: 保存完成")}static async deleteLLMConfig(t){const e=await this.getLLMConfigs();if(e.length<=1)return!1;const i=e.filter(s=>s.id!==t);await chrome.storage.sync.set({[n.LLM_CONFIGS]:i});const a=await this.getConfig();return a&&a.selectedLLMConfigId===t&&await this.saveConfig({...a,selectedLLMConfigId:i[0].id}),!0}static async setSelectedLLMConfig(t){let e=await this.getConfig();e||(e={...m});const i=await this.getLLMConfigById(t);i&&await this.saveConfig({...e,selectedLLMConfigId:t,llm:{provider:i.provider,apiUrl:i.apiUrl,apiKey:i.apiKey,model:i.model,timeout:i.timeout}})}static async getMindmaps(){return(await chrome.storage.local.get(n.MINDMAPS))[n.MINDMAPS]||[]}static async saveMindmap(t){const e=await this.getMindmaps(),i=e.findIndex(a=>a.id===t.id);i>=0?e[i]=t:e.unshift(t),e.length>50&&e.splice(50),await chrome.storage.local.set({[n.MINDMAPS]:e,[n.LATEST_MINDMAP_ID]:t.id})}static async getLatestMindmap(){const e=(await chrome.storage.local.get(n.LATEST_MINDMAP_ID))[n.LATEST_MINDMAP_ID];return e&&(await this.getMindmaps()).find(a=>a.id===e)||null}static async getMindmapById(t){return(await this.getMindmaps()).find(i=>i.id===t)||null}static async getLatestMindmapByUrl(t){console.log("[StorageService] getLatestMindmapByUrl 被调用, URL:",t);const e=await this.getMindmaps();console.log("[StorageService] 存储的思维导图数量:",e.length),e.length>0&&console.log("[StorageService] 存储的思维导图列表:",e.map(o=>({id:o.id,videoTitle:o.videoTitle,videoUrl:o.videoUrl})));const i=o=>{try{const r=new URL(o).pathname.match(/\/video\/(BV[\w]+|av\d+)/i);return r?r[1]:null}catch{return null}},a=i(t);console.log("[StorageService] 提取的视频ID:",a);const s=e.filter(o=>a?i(o.videoUrl)===a:o.videoUrl===t);return console.log("[StorageService] 匹配的思维导图数量:",s.length),s.length>0?s[0]:null}static async deleteMindmap(t){const i=(await this.getMindmaps()).filter(a=>a.id!==t);await chrome.storage.local.set({[n.MINDMAPS]:i})}static async clearMindmaps(){await chrome.storage.local.remove([n.MINDMAPS,n.LATEST_MINDMAP_ID])}}export{m as D,f as S,p as c};
