var M=Object.defineProperty;var b=(n,e,t)=>e in n?M(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var h=(n,e,t)=>(b(n,typeof e!="symbol"?e+"":e,t),t);import{L as f}from"./llmService-fb03cb47.js";import{S as l,D as S}from"./storageService-59ff9c65.js";let g;const A=new Uint8Array(16);function E(){if(!g&&(g=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!g))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return g(A)}const r=[];for(let n=0;n<256;++n)r.push((n+256).toString(16).slice(1));function D(n,e=0){return r[n[e+0]]+r[n[e+1]]+r[n[e+2]]+r[n[e+3]]+"-"+r[n[e+4]]+r[n[e+5]]+"-"+r[n[e+6]]+r[n[e+7]]+"-"+r[n[e+8]]+r[n[e+9]]+"-"+r[n[e+10]]+r[n[e+11]]+r[n[e+12]]+r[n[e+13]]+r[n[e+14]]+r[n[e+15]]}const _=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),v={randomUUID:_};function w(n,e,t){if(v.randomUUID&&!e&&!n)return v.randomUUID();n=n||{};const a=n.random||(n.rng||E)();if(a[6]=a[6]&15|64,a[8]=a[8]&63|128,e){t=t||0;for(let s=0;s<16;++s)e[t+s]=a[s];return e}return D(a)}class C{static extractVideoId(e){var t;try{const s=new URL(e).pathname.split("/").filter(Boolean);return s[0]==="video"&&s[1]||s[0]==="video"&&((t=s[1])!=null&&t.startsWith("av"))?s[1]:null}catch{return null}}static async getVideoInfo(e){if(e.startsWith("BV")){const s=await(await fetch(`https://api.bilibili.com/x/web-interface/view?bvid=${e}`,{credentials:"include"})).json();if(s.code!==0)throw new Error(s.message||"获取视频信息失败");return{aid:s.data.aid,bvid:s.data.bvid,cid:s.data.cid,title:s.data.title,author:s.data.owner.name}}else{const a=parseInt(e.replace("av","")),i=await(await fetch(`https://api.bilibili.com/x/web-interface/view?aid=${a}`,{credentials:"include"})).json();if(i.code!==0)throw new Error(i.message||"获取视频信息失败");return{aid:i.data.aid,bvid:i.data.bvid,cid:i.data.cid,title:i.data.title,author:i.data.owner.name}}}static async getSubtitleList(e,t){const s=await(await fetch(`https://api.bilibili.com/x/player/wbi/v2?aid=${e}&cid=${t}`,{credentials:"include"})).json();if(s.code!==0)throw new Error(s.message||"获取字幕列表失败");return s.data.subtitle.subtitles||[]}static filterChineseSubtitles(e){return e.filter(t=>{const a=t.lan||t.lan_doc;return a==="ai-zh"||a==="zh-CN"||a==="zh"||a==="cn"})}static async downloadSubtitle(e){return e.startsWith("//")&&(e="https:"+e),await(await fetch(e)).json()}static extractPlainText(e){return!e.body||!Array.isArray(e.body)?"":e.body.map(t=>t.content).filter(t=>t&&t.trim()).join(`
`)}static async downloadChineseSubtitle(e){const t=this.extractVideoId(e);if(!t)throw new Error("无法从URL中提取视频ID");const a=await this.getVideoInfo(t),s=await this.getSubtitleList(a.aid,a.cid);if(s.length===0)throw new Error("该视频没有字幕");const i=this.filterChineseSubtitles(s);if(i.length===0)throw new Error("该视频没有中文字幕");const o=await this.downloadSubtitle(i[0].subtitle_url),d=this.extractPlainText(o);return{videoUrl:e,videoTitle:a.title,subtitleText:d}}}class u{static hasCacheDirectory(e){return!!e.settings.cacheDirectory&&e.settings.cacheDirectory.trim().length>0}static async saveSubtitleFile(e,t,a){await this.saveFile(e,t)}static async saveMindmapFile(e,t,a){await this.saveFile(e,t)}static async saveFile(e,t){const a=`data:text/plain;charset=utf-8,${encodeURIComponent(e)}`;try{const s=t.replace(/[^a-zA-Z0-9\u4e00-\u9fff_.\-]/g,"_"),i=`${this.SUBDIR}/${s}`;console.log("[FileService] 尝试保存到子目录:",i);try{await this.downloadFile(a,i),console.log("[FileService] 子目录保存成功");return}catch(o){console.warn("[FileService] 子目录保存失败，尝试保存到根目录:",o),await this.downloadFile(a,s),console.log("[FileService] 根目录保存成功");return}}catch(s){throw console.error("[FileService] 所有保存方法都失败:",s),s}}static async downloadFile(e,t){return new Promise((a,s)=>{chrome.downloads.download({url:e,filename:t,saveAs:!1,conflictAction:"uniquify"},i=>{if(chrome.runtime.lastError){s(new Error(chrome.runtime.lastError.message));return}if(!i){s(new Error("下载ID无效"));return}console.log("[FileService] 下载已启动, id:",i,"文件名:",t);const o=setTimeout(()=>{chrome.downloads.onChanged.removeListener(d),s(new Error("下载超时 (30秒)"))},3e4),d=c=>{var m,T,y;if(c.id===i){if(((m=c.state)==null?void 0:m.current)==="complete")clearTimeout(o),chrome.downloads.onChanged.removeListener(d),console.log("[FileService] 下载完成, id:",i),a();else if(((T=c.state)==null?void 0:T.current)==="interrupted"){clearTimeout(o),chrome.downloads.onChanged.removeListener(d);const k=((y=c.error)==null?void 0:y.current)||"未知错误";console.error("[FileService] 下载被中断:",k),s(new Error("下载被中断: "+k))}}};chrome.downloads.onChanged.addListener(d)})})}static generateSubtitleFileName(e,t){const a=e.replace(/[^a-zA-Z0-9\u4e00-\u9fff]/g,"_").slice(0,50),s=t!==void 0?`_${t}`:"";return`${a}_字幕${s}.txt`}static generateMindmapFileName(e,t){const a=e.replace(/[^a-zA-Z0-9\u4e00-\u9fff]/g,"_").slice(0,50),s=t!==void 0?`_${t}`:"";return`${a}_思维导图${s}.md`}static getSubDirectoryName(){return this.SUBDIR}}h(u,"SUBDIR","bilibili_mindmap");const p="active_tasks";class x{constructor(){h(this,"tasks",new Map);h(this,"isProcessing",!1);this.restoreTasks()}async restoreTasks(){try{const t=(await chrome.storage.local.get(p))[p]||[];for(const a of t)a.status!=="completed"&&a.status!=="failed"&&(a.status="pending",this.tasks.set(a.id,a));console.log("[TaskManager] Restored tasks:",this.tasks.size)}catch(e){console.error("[TaskManager] Failed to restore tasks:",e)}}async saveTasks(){try{const e=Array.from(this.tasks.values());await chrome.storage.local.set({[p]:e})}catch(e){console.error("[TaskManager] Failed to save tasks:",e)}}async createDownloadTask(e){const t={id:w(),type:"download_subtitle",status:"pending",data:{videoUrl:e},createdAt:Date.now(),updatedAt:Date.now()};return this.tasks.set(t.id,t),await this.saveTasks(),this.processQueue(),t}async createMindmapTask(e,t,a){const s={id:w(),type:"generate_mindmap",status:"pending",data:{videoUrl:e,subtitleText:t,videoTitle:a},createdAt:Date.now(),updatedAt:Date.now()};return this.tasks.set(s.id,s),await this.saveTasks(),this.processQueue(),s}async processQueue(){if(this.isProcessing)return;const e=Array.from(this.tasks.values()).find(t=>t.status==="pending");if(e){this.isProcessing=!0;try{await this.executeTask(e)}catch(t){console.error("[TaskManager] Task execution failed:",t),e.status="failed",e.error=t instanceof Error?t.message:"Unknown error",e.updatedAt=Date.now()}finally{this.isProcessing=!1,this.processQueue()}}}async executeTask(e){switch(e.status="running",e.updatedAt=Date.now(),await this.saveTasks(),e.type){case"download_subtitle":await this.executeDownloadTask(e);break;case"generate_mindmap":await this.executeMindmapTask(e);break;default:throw new Error(`Unknown task type: ${e.type}`)}e.status="completed",e.updatedAt=Date.now(),await this.saveTasks()}async executeDownloadTask(e){const{videoUrl:t}=e.data,a=await C.downloadChineseSubtitle(t);e.result=a,await this.createMindmapTask(t,a.subtitleText,a.videoTitle)}async executeMindmapTask(e){const{videoUrl:t,subtitleText:a,videoTitle:s}=e.data,i=await l.getConfig();if(!i)throw new Error("配置未初始化");const o=f.validateConfig(i);if(!o.valid)throw new Error(o.error);const d=await f.generateMindmap(i,a),c={id:w(),videoUrl:t,videoTitle:s||"Unknown",subtitleText:a,mindmapMarkdown:d,createdAt:Date.now(),status:"completed"};await l.saveMindmap(c),u.hasCacheDirectory(i)&&await this.saveFilesToCacheDirectory(c,i.settings.cacheDirectory),e.result=c,this.notifyContentScript(c)}async saveFilesToCacheDirectory(e,t){try{const a=u.generateSubtitleFileName(e.videoTitle);await u.saveSubtitleFile(e.subtitleText,a,t);const s=u.generateMindmapFileName(e.videoTitle);await u.saveMindmapFile(e.mindmapMarkdown,s,t),console.log(`[TaskManager] 文件已保存到: ${t}`)}catch(a){console.error("[TaskManager] 保存文件到缓存目录失败:",a)}}async notifyContentScript(e){var a;const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});if(t&&t.id)try{await chrome.tabs.sendMessage(t.id,{type:"MINDMAP_GENERATED",payload:{mindmapId:e.id,mindmapData:e}}),console.log("[TaskManager] 已通知 content script 思维导图生成完成")}catch(s){(a=s==null?void 0:s.message)!=null&&a.includes("Receiving end does not exist")?console.log("[TaskManager] Content script 未就绪，思维导图已保存到存储中"):console.error("[TaskManager] 通知 content script 失败:",s)}}getTask(e){return this.tasks.get(e)}getCurrentTask(){const e=Array.from(this.tasks.values()).find(i=>i.status==="running");if(e)return e;const t=Array.from(this.tasks.values()).filter(i=>i.status==="pending").sort((i,o)=>i.createdAt-o.createdAt);if(t.length>0)return t[0];const a=Date.now();return Array.from(this.tasks.values()).filter(i=>(i.status==="completed"||i.status==="failed")&&a-(i.updatedAt||0)<3e4).sort((i,o)=>(o.updatedAt||0)-(i.updatedAt||0))[0]}async cleanupExpiredTasks(){const e=Date.now(),t=24*60*60*1e3;for(const[a,s]of this.tasks)e-s.createdAt>t&&this.tasks.delete(a);await this.saveTasks()}}class U{constructor(e){this.taskManager=e,this.init()}init(){chrome.runtime.onMessage.addListener((e,t,a)=>(this.handleMessage(e).then(a).catch(s=>{console.error("[MessageHandler] Error:",s),a({error:s.message})}),!0))}async handleMessage(e){switch(e==null?void 0:e.type){case"DOWNLOAD_SUBTITLE":return await this.handleDownloadSubtitle(e.payload);case"GENERATE_MINDMAP_DIRECT":return await this.handleGenerateMindmapDirect(e.payload);case"GET_LATEST_MINDMAP":return await this.handleGetLatestMindmap();case"GET_LATEST_MINDMAP_BY_URL":return await this.handleGetLatestMindmapByUrl(e.payload);case"GET_CURRENT_TASK":return await this.handleGetCurrentTask();case"CLEAR_MINDMAPS":return await this.handleClearMindmaps();default:return{error:"Unknown message type"}}}async handleDownloadSubtitle(e){return{taskId:(await this.taskManager.createDownloadTask(e.videoUrl)).id}}async handleGetLatestMindmap(){console.log("[MessageHandler] GET_LATEST_MINDMAP 请求");const e=await l.getConfig();if(console.log("[MessageHandler] 当前配置:",e),!(e!=null&&e.settings.enableCache))return console.log("[MessageHandler] 缓存已禁用"),{mindmap:null};const t=await l.getLatestMindmap();return console.log("[MessageHandler] 获取到的思维导图:",t?`ID: ${t.id}, 标题: ${t.videoTitle}`:"null"),{mindmap:t}}async handleGetLatestMindmapByUrl(e){console.log("[MessageHandler] GET_LATEST_MINDMAP_BY_URL 请求, URL:",e.videoUrl);const t=await l.getConfig();if(console.log("[MessageHandler] 当前配置:",t),!(t!=null&&t.settings.enableCache))return console.log("[MessageHandler] 缓存已禁用"),{mindmap:null};const a=await l.getLatestMindmapByUrl(e.videoUrl);return console.log("[MessageHandler] 获取到的思维导图:",a?`ID: ${a.id}, 标题: ${a.videoTitle}`:"null"),{mindmap:a}}async handleClearMindmaps(){return await l.clearMindmaps(),{success:!0}}async handleGetCurrentTask(){return{task:this.taskManager.getCurrentTask()}}async handleGenerateMindmapDirect(e){return{taskId:(await this.taskManager.createMindmapTask(e.videoUrl,e.subtitleText,e.videoTitle)).id}}}async function F(){await l.getConfig()||await l.saveConfig(S)}F().then(async()=>{console.log("[Background] Plugin initialized");const n=new x;new U(n),chrome.runtime.onInstalled.addListener(e=>{e.reason==="install"?console.log("[Background] Extension installed"):e.reason==="update"&&console.log("[Background] Extension updated")}),setInterval(()=>{n.cleanupExpiredTasks().catch(console.error)},60*60*1e3),console.log("[Background] Service worker ready")}).catch(console.error);
