import{L as f}from"./llmService-fb03cb47.js";import{S as l,D as M}from"./storageService-b18f33a8.js";let h;const b=new Uint8Array(16);function S(){if(!h&&(h=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!h))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return h(b)}const o=[];for(let i=0;i<256;++i)o.push((i+256).toString(16).slice(1));function A(i,e=0){return o[i[e+0]]+o[i[e+1]]+o[i[e+2]]+o[i[e+3]]+"-"+o[i[e+4]]+o[i[e+5]]+"-"+o[i[e+6]]+o[i[e+7]]+"-"+o[i[e+8]]+o[i[e+9]]+"-"+o[i[e+10]]+o[i[e+11]]+o[i[e+12]]+o[i[e+13]]+o[i[e+14]]+o[i[e+15]]}const E=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),v={randomUUID:E};function w(i,e,t){if(v.randomUUID&&!e&&!i)return v.randomUUID();i=i||{};const a=i.random||(i.rng||S)();if(a[6]=a[6]&15|64,a[8]=a[8]&63|128,e){t=t||0;for(let s=0;s<16;++s)e[t+s]=a[s];return e}return A(a)}class D{static extractVideoId(e){var t;try{const s=new URL(e).pathname.split("/").filter(Boolean);return s[0]==="video"&&s[1]||s[0]==="video"&&((t=s[1])!=null&&t.startsWith("av"))?s[1]:null}catch{return null}}static async getVideoInfo(e){if(e.startsWith("BV")){const s=await(await fetch(`https://api.bilibili.com/x/web-interface/view?bvid=${e}`,{credentials:"include"})).json();if(s.code!==0)throw new Error(s.message||"获取视频信息失败");return{aid:s.data.aid,bvid:s.data.bvid,cid:s.data.cid,title:s.data.title,author:s.data.owner.name}}else{const a=parseInt(e.replace("av","")),n=await(await fetch(`https://api.bilibili.com/x/web-interface/view?aid=${a}`,{credentials:"include"})).json();if(n.code!==0)throw new Error(n.message||"获取视频信息失败");return{aid:n.data.aid,bvid:n.data.bvid,cid:n.data.cid,title:n.data.title,author:n.data.owner.name}}}static async getSubtitleList(e,t){const s=await(await fetch(`https://api.bilibili.com/x/player/wbi/v2?aid=${e}&cid=${t}`,{credentials:"include"})).json();if(s.code!==0)throw new Error(s.message||"获取字幕列表失败");return s.data.subtitle.subtitles||[]}static filterChineseSubtitles(e){return e.filter(t=>{const a=t.lan||t.lan_doc;return a==="ai-zh"||a==="zh-CN"||a==="zh"||a==="cn"})}static async downloadSubtitle(e){return e.startsWith("//")&&(e="https:"+e),await(await fetch(e)).json()}static extractPlainText(e){return!e.body||!Array.isArray(e.body)?"":e.body.map(t=>t.content).filter(t=>t&&t.trim()).join(`
`)}static async downloadChineseSubtitle(e){const t=this.extractVideoId(e);if(!t)throw new Error("无法从URL中提取视频ID");const a=await this.getVideoInfo(t),s=await this.getSubtitleList(a.aid,a.cid);if(s.length===0)throw new Error("该视频没有字幕");const n=this.filterChineseSubtitles(s);if(n.length===0)throw new Error("该视频没有中文字幕");const r=await this.downloadSubtitle(n[0].subtitle_url),c=this.extractPlainText(r);return{videoUrl:e,videoTitle:a.title,subtitleText:c}}}class u{static hasCacheDirectory(e){return!!e.settings.cacheDirectory&&e.settings.cacheDirectory.trim().length>0}static async saveSubtitleFile(e,t,a){await this.saveFile(e,t)}static async saveMindmapFile(e,t,a){await this.saveFile(e,t)}static async saveFile(e,t){const a=`data:text/plain;charset=utf-8,${encodeURIComponent(e)}`;try{const s=t.replace(/[^a-zA-Z0-9\u4e00-\u9fff_.\-]/g,"_"),n=`${this.SUBDIR}/${s}`;console.log("[FileService] 尝试保存到子目录:",n);try{await this.downloadFile(a,n),console.log("[FileService] 子目录保存成功");return}catch(r){console.warn("[FileService] 子目录保存失败，尝试保存到根目录:",r),await this.downloadFile(a,s),console.log("[FileService] 根目录保存成功");return}}catch(s){throw console.error("[FileService] 所有保存方法都失败:",s),s}}static async downloadFile(e,t){return new Promise((a,s)=>{chrome.downloads.download({url:e,filename:t,saveAs:!1,conflictAction:"uniquify"},n=>{if(chrome.runtime.lastError){s(new Error(chrome.runtime.lastError.message));return}if(!n){s(new Error("下载ID无效"));return}console.log("[FileService] 下载已启动, id:",n,"文件名:",t);const r=setTimeout(()=>{chrome.downloads.onChanged.removeListener(c),s(new Error("下载超时 (30秒)"))},3e4),c=d=>{var m,T,y;if(d.id===n){if(((m=d.state)==null?void 0:m.current)==="complete")clearTimeout(r),chrome.downloads.onChanged.removeListener(c),console.log("[FileService] 下载完成, id:",n),a();else if(((T=d.state)==null?void 0:T.current)==="interrupted"){clearTimeout(r),chrome.downloads.onChanged.removeListener(c);const k=((y=d.error)==null?void 0:y.current)||"未知错误";console.error("[FileService] 下载被中断:",k),s(new Error("下载被中断: "+k))}}};chrome.downloads.onChanged.addListener(c)})})}static generateSubtitleFileName(e,t){const a=e.replace(/[^a-zA-Z0-9\u4e00-\u9fff]/g,"_").slice(0,50),s=t!==void 0?`_${t}`:"";return`${a}_字幕${s}.txt`}static generateMindmapFileName(e,t){const a=e.replace(/[^a-zA-Z0-9\u4e00-\u9fff]/g,"_").slice(0,50),s=t!==void 0?`_${t}`:"";return`${a}_思维导图${s}.md`}static getSubDirectoryName(){return this.SUBDIR}}u.SUBDIR="bilibili_mindmap";const p="active_tasks";class _{constructor(){this.tasks=new Map,this.isProcessing=!1,this.restoreTasks()}async restoreTasks(){try{const t=(await chrome.storage.local.get(p))[p]||[];for(const a of t)a.status!=="completed"&&a.status!=="failed"&&(a.status="pending",this.tasks.set(a.id,a));console.log("[TaskManager] Restored tasks:",this.tasks.size)}catch(e){console.error("[TaskManager] Failed to restore tasks:",e)}}async saveTasks(){try{const e=Array.from(this.tasks.values());await chrome.storage.local.set({[p]:e})}catch(e){console.error("[TaskManager] Failed to save tasks:",e)}}async createDownloadTask(e,t){const a={id:w(),type:"download_subtitle",status:"pending",data:{videoUrl:e},createdAt:Date.now(),updatedAt:Date.now(),tabId:t};return this.tasks.set(a.id,a),await this.saveTasks(),this.processQueue(),a}async createMindmapTask(e,t,a,s){const n={id:w(),type:"generate_mindmap",status:"pending",data:{videoUrl:e,subtitleText:t,videoTitle:a},createdAt:Date.now(),updatedAt:Date.now(),tabId:s};return this.tasks.set(n.id,n),await this.saveTasks(),this.processQueue(),n}async processQueue(){if(this.isProcessing)return;const e=Array.from(this.tasks.values()).find(t=>t.status==="pending");if(e){this.isProcessing=!0;try{await this.executeTask(e)}catch(t){console.error("[TaskManager] Task execution failed:",t),e.status="failed",e.error=t instanceof Error?t.message:"Unknown error",e.updatedAt=Date.now()}finally{this.isProcessing=!1,this.processQueue()}}}async executeTask(e){switch(e.status="running",e.updatedAt=Date.now(),await this.saveTasks(),e.type){case"download_subtitle":await this.executeDownloadTask(e);break;case"generate_mindmap":await this.executeMindmapTask(e);break;default:throw new Error(`Unknown task type: ${e.type}`)}e.status="completed",e.updatedAt=Date.now(),await this.saveTasks()}async executeDownloadTask(e){const{videoUrl:t}=e.data,a=await D.downloadChineseSubtitle(t);e.result=a,await this.createMindmapTask(t,a.subtitleText,a.videoTitle,e.tabId)}async executeMindmapTask(e){const{videoUrl:t,subtitleText:a,videoTitle:s}=e.data,n=await l.getConfig();if(!n)throw new Error("配置未初始化");const r=f.validateConfig(n);if(!r.valid)throw new Error(r.error);const c=await f.generateMindmap(n,a),d={id:w(),videoUrl:t,videoTitle:s||"Unknown",subtitleText:a,mindmapMarkdown:c,createdAt:Date.now(),status:"completed"};await l.saveMindmap(d),u.hasCacheDirectory(n)&&await this.saveFilesToCacheDirectory(d,n.settings.cacheDirectory),e.result=d,this.notifyContentScript(d,e.tabId)}async saveFilesToCacheDirectory(e,t){try{const a=u.generateSubtitleFileName(e.videoTitle);await u.saveSubtitleFile(e.subtitleText,a,t);const s=u.generateMindmapFileName(e.videoTitle);await u.saveMindmapFile(e.mindmapMarkdown,s,t),console.log(`[TaskManager] 文件已保存到: ${t}`)}catch(a){console.error("[TaskManager] 保存文件到缓存目录失败:",a)}}async notifyContentScript(e,t){var s,n;if(t)try{await chrome.tabs.sendMessage(t,{type:"MINDMAP_GENERATED",payload:{mindmapId:e.id,mindmapData:e}}),console.log("[TaskManager] 已通知 content script 思维导图生成完成 (tabId:",t,")");return}catch(r){(s=r==null?void 0:r.message)!=null&&s.includes("Receiving end does not exist")||(n=r==null?void 0:r.message)!=null&&n.includes("No tab with id")?console.log("[TaskManager] 目标标签页不可用，思维导图已保存到存储中"):console.error("[TaskManager] 通知 content script 失败:",r);return}const a=e.videoUrl;if(a)try{const r=await chrome.tabs.query({});for(const c of r)if(c.id&&c.url&&c.url.includes(a.split("?")[0]))try{await chrome.tabs.sendMessage(c.id,{type:"MINDMAP_GENERATED",payload:{mindmapId:e.id,mindmapData:e}}),console.log("[TaskManager] 已通知匹配URL的标签页 (tabId:",c.id,")");return}catch{}}catch(r){console.error("[TaskManager] 查找匹配标签页失败:",r)}console.log("[TaskManager] 未找到可通知的标签页，思维导图已保存到存储中")}getTask(e){return this.tasks.get(e)}getCurrentTask(){const e=Array.from(this.tasks.values()).find(n=>n.status==="running");if(e)return e;const t=Array.from(this.tasks.values()).filter(n=>n.status==="pending").sort((n,r)=>n.createdAt-r.createdAt);if(t.length>0)return t[0];const a=Date.now();return Array.from(this.tasks.values()).filter(n=>(n.status==="completed"||n.status==="failed")&&a-(n.updatedAt||0)<3e4).sort((n,r)=>(r.updatedAt||0)-(n.updatedAt||0))[0]}async cleanupExpiredTasks(){const e=Date.now(),t=24*60*60*1e3;for(const[a,s]of this.tasks)e-s.createdAt>t&&this.tasks.delete(a);await this.saveTasks()}}class x{constructor(e){this.taskManager=e,this.init()}init(){chrome.runtime.onMessage.addListener((e,t,a)=>(this.handleMessage(e,t).then(a).catch(s=>{console.error("[MessageHandler] Error:",s),a({error:s.message})}),!0))}async handleMessage(e,t){var s;const a=(s=t==null?void 0:t.tab)==null?void 0:s.id;switch(e==null?void 0:e.type){case"DOWNLOAD_SUBTITLE":return await this.handleDownloadSubtitle(e.payload,a);case"GENERATE_MINDMAP_DIRECT":return await this.handleGenerateMindmapDirect(e.payload,a);case"GET_LATEST_MINDMAP":return await this.handleGetLatestMindmap();case"GET_LATEST_MINDMAP_BY_URL":return await this.handleGetLatestMindmapByUrl(e.payload);case"GET_CURRENT_TASK":return await this.handleGetCurrentTask();case"CLEAR_MINDMAPS":return await this.handleClearMindmaps();default:return{error:"Unknown message type"}}}async handleDownloadSubtitle(e,t){return{taskId:(await this.taskManager.createDownloadTask(e.videoUrl,t)).id}}async handleGetLatestMindmap(){console.log("[MessageHandler] GET_LATEST_MINDMAP 请求");const e=await l.getConfig();if(console.log("[MessageHandler] 当前配置:",e),!(e!=null&&e.settings.enableCache))return console.log("[MessageHandler] 缓存已禁用"),{mindmap:null};const t=await l.getLatestMindmap();return console.log("[MessageHandler] 获取到的思维导图:",t?`ID: ${t.id}, 标题: ${t.videoTitle}`:"null"),{mindmap:t}}async handleGetLatestMindmapByUrl(e){console.log("[MessageHandler] GET_LATEST_MINDMAP_BY_URL 请求, URL:",e.videoUrl);const t=await l.getConfig();if(console.log("[MessageHandler] 当前配置:",t),!(t!=null&&t.settings.enableCache))return console.log("[MessageHandler] 缓存已禁用"),{mindmap:null};const a=await l.getLatestMindmapByUrl(e.videoUrl);return console.log("[MessageHandler] 获取到的思维导图:",a?`ID: ${a.id}, 标题: ${a.videoTitle}`:"null"),{mindmap:a}}async handleClearMindmaps(){return await l.clearMindmaps(),{success:!0}}async handleGetCurrentTask(){return{task:this.taskManager.getCurrentTask()}}async handleGenerateMindmapDirect(e,t){return{taskId:(await this.taskManager.createMindmapTask(e.videoUrl,e.subtitleText,e.videoTitle,t)).id}}}async function C(){await l.getConfig()||await l.saveConfig(M)}async function g(){await l.isPaused()?(await chrome.action.setBadgeText({text:"||"}),await chrome.action.setBadgeBackgroundColor({color:"#FF4444"}),await chrome.action.setTitle({title:"自动思维导图（已暂停）- 点击恢复"})):(await chrome.action.setBadgeText({text:""}),await chrome.action.setTitle({title:"自动思维导图（运行中）- 点击暂停"}))}async function U(){const i=await l.togglePaused();return console.log("[Background] Pause state toggled:",i?"PAUSED":"RUNNING"),await g(),i}C().then(async()=>{console.log("[Background] Plugin initialized");const i=new _;new x(i),await g(),chrome.action.onClicked.addListener(async e=>{console.log("[Background] Extension icon clicked"),await U()}),chrome.runtime.onInstalled.addListener(async e=>{e.reason==="install"?(console.log("[Background] Extension installed"),await g()):e.reason==="update"&&(console.log("[Background] Extension updated"),await g())}),setInterval(()=>{i.cleanupExpiredTasks().catch(console.error)},60*60*1e3),console.log("[Background] Service worker ready")}).catch(console.error);
